name: 🏷️ Generate Tag Pages from TIL

on:
  schedule:
    - cron: "0 0 * * *" # 매일 자정 실행
  workflow_dispatch:

jobs:
  generate-tags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Parse TIL Tags and Generate Pages
        run: |
          python3 <<EOF
          import os, yaml
          from pathlib import Path

          REPO_URL = "https://github.com/MinHyeok-lee1/TIL/blob/main/"
          root_dir = Path(".")
          tag_map = {}

          for path in root_dir.rglob("*.md"):
              if "tags/" in str(path):  # tags 폴더 제외
                  continue

              try:
                  content = path.read_text(encoding="utf-8")
                  parts = content.split("---")
                  if len(parts) >= 3:
                      meta = yaml.safe_load(parts[1])
                      title = meta.get("title", path.name)
                      date = meta.get("date", "")
                      summary = meta.get("summary", "")
                      tags = meta.get("tags", [])

                      relpath = path.relative_to(root_dir).as_posix()
                      link = f"{REPO_URL}{relpath}"
                      for tag in tags:
                          tag_map.setdefault(tag, []).append(
                              (title, date, summary, link)
                          )
              except Exception as e:
                  print(f"⚠️ Failed to parse {path}: {e}")

          os.makedirs("tags", exist_ok=True)

          for tag, entries in tag_map.items():
              entries.sort(key=lambda x: x[1], reverse=True)
              content = f"# 🏷️ Tag: {tag}\n\n| Title | Date | Summary |\n|-------|------|---------|\n"
              for title, date, summary, link in entries:
                  content += f"| [{title}]({link}) | {date} | {summary} |\n"
              with open(f"tags/{tag}.md", "w", encoding="utf-8") as f:
                  f.write(content)
          EOF

      - name: Commit and Push if Changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add tags
          git diff --cached --quiet || git commit -m "🏷️ update: auto-generated tag pages"
          git push
