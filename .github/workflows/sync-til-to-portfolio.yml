name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Move and Rename Directories
        run: |
          cd portfolio-repo/src/pages/til

          # Rename year folder
          if [ -d "2025" ]; then
            rm -rf "til-2025"
            mv "2025" "til-2025"
          fi

          # Rename month folder inside year folder
          if [ -d "til-2025/06" ]; then
            rm -rf "til-2025/til-06"
            mv "til-2025/06" "til-2025/til-06"
          fi

      - name: Ensure directory structure exists
        run: |
          mkdir -p portfolio-repo/src/pages/til/til-2025/til-06
          mkdir -p portfolio-repo/src/pages/til/tags

      - name: Convert .md to .mdx
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" -print0 | while IFS= read -r -d '' file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Create index.mdx and _meta.json in all folders
        run: |
          BASE="portfolio-repo/src/pages/til"

          # til/index.mdx
          cat <<EOF > "$BASE/index.mdx"
          # üìì Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
          Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)
          - [2025ÎÖÑ 6Ïõî](/til/til-2025/til-06)
          EOF

          echo '{ "index": "ÏÜåÍ∞ú", "til-2025": "2025ÎÖÑ TIL" }' > "$BASE/_meta.json"

          # til-2025/index.mdx
          mkdir -p "$BASE/til-2025"
          echo -e "# ÏÜåÍ∞ú\n\n2025ÎÖÑ TIL Í∏∞Î°ùÏûÖÎãàÎã§." > "$BASE/til-2025/index.mdx"
          echo '{ "index": "ÏÜåÍ∞ú", "til-06": "06Ïõî TIL" }' > "$BASE/til-2025/_meta.json"

          # til-06/index.mdx + _meta.json
          mkdir -p "$BASE/til-2025/til-06"
          echo -e "# ÏÜåÍ∞ú\n\n6ÏõîÏùò TIL Í∏∞Î°ùÏûÖÎãàÎã§." > "$BASE/til-2025/til-06/index.mdx"

          echo '{' > "$BASE/til-2025/til-06/_meta.json"
          echo '  "index": "ÏÜåÍ∞ú",' >> "$BASE/til-2025/til-06/_meta.json"
          find "$BASE/til-2025/til-06" -type f -name "*.mdx" | while read file; do
            fname=$(basename "$file" .mdx)
            day=${fname:0:2}
            title=$(echo "${fname:3}" | sed 's/-/ /g' | sed -E 's/(^| )(\w)/\U\2/g')
            echo "  \"$fname\": \"$dayÏùº $title\"," >> "$BASE/til-2025/til-06/_meta.json"
          done
          sed -i '$ s/,$//' "$BASE/til-2025/til-06/_meta.json"
          echo '}' >> "$BASE/til-2025/til-06/_meta.json"

      - name: Generate tag pages
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          TIL_DIR="portfolio-repo/src/pages/til/til-2025/til-06"
          mkdir -p "$TAGS_DIR"

          # index.mdx for tags
          cat <<EOF > "$TAGS_DIR/index.mdx"
          # üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå

          Ï£ºÏöî ÌÉúÍ∑∏Î≥Ñ TIL Î™®ÏùåÏûÖÎãàÎã§. Í∞Å Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏÑ∏Î∂Ä ÎÇ¥Ïö©ÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.

          | ÌÉúÍ∑∏ | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |
          |------|--------------|------------------|
          EOF

          echo '{ "index": "ÏÜåÍ∞ú" }' > "$TAGS_DIR/_meta.json"

          # Create tag-specific files
          tags=$(grep -rh "tags:" "$TIL_DIR" | sed -E 's/.*tags: \[(.*)\].*/\1/' | tr ',' '\n' | sed 's/[][]//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sort -u)

          for tag in $tags; do
            tag_file="$TAGS_DIR/$tag.mdx"
            tag_title=$(echo "$tag" | sed -E 's/(^| )(\w)/\U\2/g')

            echo "# üè∑Ô∏è $tag_title TIL Î™®Ïùå" > "$tag_file"
            echo "" >> "$tag_file"
            echo "| Ï†úÎ™© | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$tag_file"
            echo "|------|--------------|------------------|" >> "$tag_file"

            for file in "$TIL_DIR"/*.mdx; do
              if grep -q "$tag" "$file"; then
                fname=$(basename "$file" .mdx)
                title=$(echo "${fname:3}" | sed 's/-/ /g' | sed -E 's/(^| )(\w)/\U\2/g')
                nextra="/til/til-2025/til-06/$fname"
                github="https://github.com/MinHyeok-lee1/TIL/blob/main/src/pages/til/til-2025/til-06/$fname.mdx"
                echo "| $title | [$nextra]($nextra) | [GitHub]($github) |" >> "$tag_file"
              fi
            done

            echo "| $tag_title | [/til/tags/$tag](/til/tags/$tag) | [GitHub](https://github.com/MinHyeok-lee1/TIL/tree/main/src/pages/til/tags/$tag.mdx) |" >> "$TAGS_DIR/index.mdx"
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
