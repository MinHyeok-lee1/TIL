name: ğŸ”„ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch: # âœ… ìˆ˜ë™ ì‹¤í–‰ ì§€ì›

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Create index.mdx (ê³ ì • í…ìŠ¤íŠ¸)
        run: |
          mkdir -p portfolio-repo/src/pages/til
          cat <<EOF > portfolio-repo/src/pages/til/index.mdx
          # ğŸ““ Today I Learned (TIL)

          > ê¾¸ì¤€í•œ ê¸°ë¡ì€ ìµœê³ ì˜ ì„±ì¥ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.  
          ê°œë°œ/ì„ë² ë””ë“œ/ë„êµ¬ì— ëŒ€í•œ í•™ìŠµ ê¸°ë¡ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

          ## ğŸ“… ì—°ë„ë³„

          - [ğŸ·ï¸ íƒœê·¸ ëª¨ìŒ](/til/tags)
          - [2025ë…„ 6ì›”](/til/til-2025/til-06)
          EOF

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="ğŸ“ Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          ë³€ê²½ëœ íŒŒì¼ ìˆ˜: $FILE_COUNTê°œ

          ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:
          $FILE_LIST
          EOF
          )
          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "âš ï¸ Git push failed"; exit 1; }
