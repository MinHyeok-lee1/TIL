name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch: # ‚úÖ ÏàòÎèô Ïã§Ìñâ ÏßÄÏõê

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy and Convert TIL files
        run: |
          mkdir -p portfolio-repo/src/pages/til

          for filepath in $(find til-repo -name "*.md"); do
            relpath="${filepath#til-repo/}"
            if [[ "$relpath" == tags/* ]]; then
              dest_dir="portfolio-repo/src/pages/til/tags"
              mkdir -p "$dest_dir"
              cp "$filepath" "$dest_dir"
            else
              year=$(echo "$relpath" | cut -d'/' -f1)
              month=$(echo "$relpath" | cut -d'/' -f2)
              filename=$(basename "$relpath" .md)
              dest_dir="portfolio-repo/src/pages/til/til-$year/til-$month"
              mkdir -p "$dest_dir"
              cp "$filepath" "$dest_dir/$filename.mdx"
            fi
          done

      - name: Generate index.mdx and _meta.json files
        run: |
          echo "üìÅ Generating index.mdx and _meta.json..."

          create_meta_and_index() {
            DIR=$1
            TITLE=$2
            HIDE_INDEX=$3
            INDEX_FILE="$DIR/index.mdx"
            META_FILE="$DIR/_meta.json"

            mkdir -p "$DIR"

            if [ ! -f "$INDEX_FILE" ]; then
              echo "# $TITLE" > "$INDEX_FILE"
              echo "" >> "$INDEX_FILE"
              echo "$TITLE ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX_FILE"
            fi

            echo "{" > "$META_FILE"
            if [ "$HIDE_INDEX" = true ]; then
              echo "  \"index\": { \"display\": \"hidden\" }," >> "$META_FILE"
            else
              echo "  \"index\": \"ÏÜåÍ∞ú\"," >> "$META_FILE"
            fi

            for entry in $(find "$DIR" -mindepth 1 -maxdepth 1 \( -type d -o -name '*.mdx' \) ! -name 'index.mdx' | sort); do
              name=$(basename "$entry")
              key="${name%.mdx}"
              case $key in
                til-[0-9][0-9]) label="${key#til-}Ïõî TIL";;
                til-[0-9][0-9][0-9][0-9]) label="${key#til-} TIL";;
                *) label="$key";;
              esac
              echo "  \"$key\": \"$label\"," >> "$META_FILE"
            done

            sed -i '$ s/,$//' "$META_FILE" || sed -i '' '$ s/,$//' "$META_FILE" || true
            echo "}" >> "$META_FILE"
          }

          # til/index.mdx (ÏÜåÍ∞ú)
          TIL_ROOT="portfolio-repo/src/pages/til"
          echo "# Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
          Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [2025ÎÖÑ TIL](/til/til-2025)
          - [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)
          " > "$TIL_ROOT/index.mdx"

          create_meta_and_index "$TIL_ROOT" "üìö TIL Î™®Ïùå" false

          # Ïó∞ÎèÑÎ≥Ñ
          for year_dir in $TIL_ROOT/til-*; do
            [ -d "$year_dir" ] || continue
            create_meta_and_index "$year_dir" "üìÖ $(basename "$year_dir" | cut -d'-' -f2)ÎÖÑ TIL" true

            for month_dir in "$year_dir"/til-*; do
              [ -d "$month_dir" ] || continue
              create_meta_and_index "$month_dir" "üóìÔ∏è $(basename "$year_dir" | cut -d'-' -f2)ÎÖÑ $(basename "$month_dir" | cut -d'-' -f2)Ïõî TIL" true
            done
          done

          # ÌÉúÍ∑∏ index Î∞è meta
          TAGS_DIR="$TIL_ROOT/tags"
          TAGS_META="$TAGS_DIR/_meta.json"
          TAGS_INDEX="$TAGS_DIR/index.mdx"

          if [ -d "$TAGS_DIR" ]; then
            echo "# üè∑Ô∏è ÌÉúÍ∑∏ Î™©Î°ù

            TILÏùò ÌÉúÍ∑∏Î≥Ñ Î∂ÑÎ•òÏûÖÎãàÎã§. GitHub ÏõêÎ≥∏Í≥º ÎÇ¥Î∂Ä Î≥¥Í∏∞ Î™®Îëê Ï†úÍ≥µÌï©ÎãàÎã§.

            ### üìò ÎÇ¥Î∂Ä Î≥¥Í∏∞" > "$TAGS_INDEX"

            echo "{" > "$TAGS_META"
            echo '  "index": { "display": "hidden" },' >> "$TAGS_META"

            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)
              echo "  \"$tag\": \"$tag\"," >> "$TAGS_META"
              echo "- [$tag](/til/tags/$tag.md)" >> "$TAGS_INDEX"
            done

            echo "
            ### üîó GitHub ÏõêÎ≥∏" >> "$TAGS_INDEX"
            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)
              echo "- [$tag](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md)" >> "$TAGS_INDEX"
            done

            sed -i '$ s/,$//' "$TAGS_META" || sed -i '' '$ s/,$//' "$TAGS_META" || true
            echo "}" >> "$TAGS_META"
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò: $FILE_COUNTÍ∞ú

          Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:
          $FILE_LIST
          EOF
          )
          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
