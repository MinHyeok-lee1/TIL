name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL content into Portfolio
        run: |
          mkdir -p portfolio-repo/src/pages/til
          cp -r til-repo/2025 portfolio-repo/src/pages/til/
          cp -r til-repo/tags portfolio-repo/src/pages/til/

      - name: Rename folders to til-xxxx
        run: |
          mv portfolio-repo/src/pages/til/2025 portfolio-repo/src/pages/til/til-2025
          for month in portfolio-repo/src/pages/til/til-2025/*; do
            name=$(basename "$month")
            mv "$month" "portfolio-repo/src/pages/til/til-2025/til-$name"
          done

      - name: Convert all .md to .mdx
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" -exec bash -c 'mv "$0" "${0%.md}.mdx"' {} \;

      - name: Create index.mdx and _meta.json
        run: |
          BASE="portfolio-repo/src/pages/til"
          mkdir -p "$BASE"

          # til/index.mdx
          cat <<EOF > "$BASE/index.mdx"
          # üìì Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)
          - [2025ÎÖÑ TIL](/til/til-2025)
          EOF

          echo '{ "index": "ÏÜåÍ∞ú", "til-2025": "2025ÎÖÑ TIL", "tags": "ÌÉúÍ∑∏Î™®Ïùå" }' > "$BASE/_meta.json"

          # til-2025 index
          mkdir -p "$BASE/til-2025"
          echo "# ÏÜåÍ∞ú" > "$BASE/til-2025/index.mdx"
          echo "" >> "$BASE/til-2025/index.mdx"
          echo "2025ÎÖÑ TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$BASE/til-2025/index.mdx"
          echo "" >> "$BASE/til-2025/index.mdx"
          echo "| Ïõî | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$BASE/til-2025/index.mdx"
          echo "|----|------------------|------------------|" >> "$BASE/til-2025/index.mdx"

          echo '{ "index": "ÏÜåÍ∞ú"' > "$BASE/til-2025/_meta.json"

          for folder in "$BASE/til-2025"/til-*; do
            month=$(basename "$folder")
            month_num=$(echo "$month" | cut -d'-' -f2)
            echo "| ${month_num}Ïõî | [/til/til-2025/$month](/til/til-2025/$month) | [GitHub](https://github.com/MinHyeok-lee1/TIL/tree/main/2025/$month_num) |" >> "$BASE/til-2025/index.mdx"
            echo ", "$month": "${month_num}Ïõî TIL"" >> "$BASE/til-2025/_meta.json"

            # til-XX index
            echo "# ÏÜåÍ∞ú" > "$folder/index.mdx"
            echo "" >> "$folder/index.mdx"
            echo "${month_num}ÏõîÏùò TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$folder/index.mdx"
            echo "" >> "$folder/index.mdx"
            echo "| Ï†úÎ™© | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$folder/index.mdx"
            echo "|-------|------------------|------------------|" >> "$folder/index.mdx"

            echo '{ "index": "ÏÜåÍ∞ú"' > "$folder/_meta.json"

            for file in "$folder"/*.mdx; do
              fname=$(basename "$file" .mdx)
              [ "$fname" = "index" ] && continue
              title=$(echo "${fname:3}" | sed 's/-/ /g')
              day=$(echo "$fname" | cut -d'-' -f1)
              echo "| ${day}Ïùº $title | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-2025/$month/$fname) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/2025/$month_num/$fname.md) |" >> "$folder/index.mdx"
              echo ", "$fname": "${day}Ïùº $title"" >> "$folder/_meta.json"
            done
            echo "}" >> "$folder/_meta.json"
          done

      - name: Convert tags and generate tag index
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          TIL_DIR="portfolio-repo/src/pages/til/til-2025"

          mkdir -p "$TAGS_DIR"
          echo "# ÏÜåÍ∞ú" > "$TAGS_DIR/index.mdx"
          echo "" >> "$TAGS_DIR/index.mdx"
          echo "TIL ÌÉúÍ∑∏ Î™®ÏùåÏûÖÎãàÎã§." >> "$TAGS_DIR/index.mdx"
          echo "" >> "$TAGS_DIR/index.mdx"
          echo "| ÌÉúÍ∑∏ | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAGS_DIR/index.mdx"
          echo "|------|------------------|------------------|" >> "$TAGS_DIR/index.mdx"

          echo '{ "index": "ÏÜåÍ∞ú" }' > "$TAGS_DIR/_meta.json"

          for tag_file in "$TAGS_DIR"/*.mdx; do
            tag=$(basename "$tag_file" .mdx)
            [ "$tag" = "index" ] && continue
            echo "# üè∑Ô∏è $tag TIL Î™®Ïùå" > "$tag_file"
            echo "" >> "$tag_file"
            echo "| Ï†úÎ™© | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$tag_file"
            echo "|-------|------------------|------------------|" >> "$tag_file"

            for month_dir in "$TIL_DIR"/til-*; do
              for file in "$month_dir"/*.mdx; do
                fname=$(basename "$file" .mdx)
                [ "$fname" = "index" ] && continue
                if grep -q "$tag" "$file"; then
                  title=$(echo "${fname:3}" | sed 's/-/ /g')
                  echo "| $title | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-2025/$(basename $month_dir)/$fname) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/2025/$(echo $month_dir | grep -o '[0-9]*')/$fname.md) |" >> "$tag_file"
                fi
              done
            done

            echo "| $tag | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/tags/$tag) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_DIR/index.mdx"
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
