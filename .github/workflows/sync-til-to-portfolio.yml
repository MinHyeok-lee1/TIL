name: 🔄 Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Create _meta.json and index.mdx files
        run: |
          echo "📁 Generating _meta.json and index.mdx files..."

          # 테마 내림에서 표시의 이름을 지정해주는 함수
          localize_name() {
            case "$1" in
              2025) echo "2025\ub144 TIL";;
              06) echo "06\uc6d4 TIL";;
              07) echo "07\uc6d4 TIL";;
              *) echo "$1";;
            esac
          }

          # 번역한 이름으로 meta 만들고 index 생성
          create_meta_and_index() {
            DIR=$1
            TITLE=$2
            INDEX_FILE="$DIR/index.mdx"
            META_FILE="$DIR/_meta.json"

            mkdir -p "$DIR"

            echo "# $TITLE" > "$INDEX_FILE"
            echo "" >> "$INDEX_FILE"
            echo "$TITLE \ud398\uc774\uc9c0\uc785\ub2c8\ub2e4." >> "$INDEX_FILE"

            folders=$(find "$DIR" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort || true)
            files=$(find "$DIR" -mindepth 1 -maxdepth 1 -type f -name '*.mdx' ! -name 'index.mdx' | sort || true)

            if [ -n "$folders$files" ]; then
              echo "{" > "$META_FILE"
              echo "  \"index\": \"\uc18c\uac1c\"," >> "$META_FILE"
              for path in $folders $files; do
                name=$(basename "$path")
                label=$(localize_name "${name%.mdx}")
                echo "  \"$name\": \"$label\"," >> "$META_FILE"
              done
              sed -i '$ s/,$//' "$META_FILE" || sed -i '' '$ s/,$//' "$META_FILE"
              echo "}" >> "$META_FILE"
            fi
          }

          # 틀 글로리 바로아래 index
          TIL_DIR="portfolio-repo/src/pages/til"
          rm -rf "$TIL_DIR/20*"
          create_meta_and_index "$TIL_DIR" "\ud83d\udcda TIL \ubaa9\ub85d"

          for year_dir in til-repo/[0-9][0-9][0-9][0-9]; do
            [ -d "$year_dir" ] || continue
            year=$(basename "$year_dir")
            target_year_dir="$TIL_DIR/$year"
            mkdir -p "$target_year_dir"
            rsync -a "$year_dir/" "$target_year_dir/"
            create_meta_and_index "$target_year_dir" "\ud83d\udcc5 ${year}\ub144 TIL"

            for month_dir in "$year_dir"/*; do
              [ -d "$month_dir" ] || continue
              month=$(basename "$month_dir")
              target_month_dir="$target_year_dir/$month"
              mkdir -p "$target_month_dir"
              rsync -a "$month_dir/" "$target_month_dir/"
              create_meta_and_index "$target_month_dir" "\ud83d\uddd3\ufe0f ${year}\ub144 ${month}\uc6d4 TIL"
            done
          done

          # 태그 상의 index.mdx 생성
          TAGS_DIR="$TIL_DIR/tags"
          TAGS_META="$TAGS_DIR/_meta.json"
          TAGS_INDEX="$TAGS_DIR/index.mdx"

          if [ -d "$TAGS_DIR" ]; then
            echo "{" > "$TAGS_META"
            echo '  "index": "\uc18c\uac1c",' >> "$TAGS_META"
            echo "# \ud83c\udf9f\ufe0f \ud0dc\uadf8 \ubaa9\ub85d" > "$TAGS_INDEX"
            echo "" >> "$TAGS_INDEX"
            echo "TIL\uc758 \ud0dc\uadf8\ubcc4 \ubd84\ub958\uc785\ub2c8\ub2e4. \n" >> "$TAGS_INDEX"
            echo "| Nextra \uc815\ub9ac | GitHub \ubc14\ub85c\uac00\uae30 |" >> "$TAGS_INDEX"
            echo "|---|---|" >> "$TAGS_INDEX"

            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)
              echo "  \"$tag\": \"$tag\"," >> "$TAGS_META"
              echo "| [$tag](/til/tags/$tag.md) | [\ud83d\udd17 GitHub]https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_INDEX"
            done

            sed -i '$ s/,$//' "$TAGS_META" || sed -i '' '$ s/,$//' "$TAGS_META"
            echo "}" >> "$TAGS_META"
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          COMMIT_MSG="\ud83d\udcdd Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git commit -m "$COMMIT_MSG"
          git push || { echo "\u26a0\ufe0f Git push failed"; exit 1; }
