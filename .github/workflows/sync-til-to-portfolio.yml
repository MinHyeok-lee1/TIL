name: ğŸ”„ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files
        run: |
          mkdir -p portfolio-repo/pages/til/
          rsync -av --delete \
            --exclude '.git/' --exclude '.github/' --exclude 'tags/' --exclude 'README.md' \
            til-repo/ portfolio-repo/pages/til/

      - name: Convert .md to .mdx
        run: |
          find portfolio-repo/pages/til -name "*.md" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Generate _meta.json
        run: |
          find portfolio-repo/pages/til -type d | while read dir; do
            files=$(find "$dir" -maxdepth 1 -name "*.mdx" -exec basename {} .mdx \;)
            if [ -n "$files" ]; then
              echo "{" > "$dir/_meta.json"
              for f in $files; do
                echo "  \"$f\": \"$f\"," >> "$dir/_meta.json"
              done
              sed -i '$ s/,$//' "$dir/_meta.json"
              echo "}" >> "$dir/_meta.json"
            fi
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ğŸ“ Sync TIL to portfolio with .mdx and _meta.json" || echo "No changes"
          git push
