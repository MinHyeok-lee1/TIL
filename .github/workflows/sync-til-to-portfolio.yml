name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches: [main]
    paths: ["**/*.md"]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      years: ${{ steps.set-years.outputs.years }}

    steps:
      - name: Checkout TIL repository
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Find TIL years (for matrix)
        id: set-years
        run: |
          YEARS=$(find til-repo -mindepth 1 -maxdepth 1 -type d -regex 'til-repo/[0-9]{4}' | sed 's|til-repo/||' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "years=$YEARS" >> "$GITHUB_OUTPUT"

  build-years:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        year: ${{ fromJson(needs.setup.outputs.years) }}

    steps:
      - name: Checkout TIL repo
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Sync and convert ${{ matrix.year }}
        run: |
          YEAR=${{ matrix.year }}
          for MONTH in $(find "til-repo/$YEAR" -mindepth 1 -maxdepth 1 -type d -regex "til-repo/$YEAR/[0-9]{2}" -exec basename {} \;); do
            mkdir -p "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH"
            cp til-repo/$YEAR/$MONTH/*.md "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH/" || true
          done

          find portfolio-repo/src/pages/til/til-$YEAR -type f -name "*.md" -exec bash -c 'mv "$0" "${0%.md}.mdx"' {} \;

  finalize:
    needs: build-years
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Create index.mdx and _meta.json
        run: |
          BASE="portfolio-repo/src/pages/til"
          mkdir -p "$BASE"
          echo '{' > "$BASE/_meta.json"
          echo '  "index": "ÏÜåÍ∞ú",' >> "$BASE/_meta.json"
          echo '  "tags": "ÌÉúÍ∑∏ Î™®Ïùå"' >> "$BASE/_meta.json"

          cat <<EOF > "$BASE/index.mdx"
          # üìì Today I Learned (TIL)

          > ÍøîÏ§ÄÌïú Í∏∞Î°ùÏùÄ Ï∞∏Î°úÏö¥ ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïó¨ÏßÑÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          EOF

          echo "- [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)" >> "$BASE/index.mdx"
          for YEAR_PATH in "$BASE"/til-[0-9][0-9][0-9][0-9]; do
            YEAR=$(basename "$YEAR_PATH" | cut -d'-' -f2)
            echo "- [$YEARÎÖÑ TIL](/til/til-$YEAR)" >> "$BASE/index.mdx"
            echo '  ,"til-'$YEAR'": "'$YEAR'ÎÖÑ TIL"' >> "$BASE/_meta.json"

            echo "# ÏÜåÍ∞ú" > "$YEAR_PATH/index.mdx"
            echo "" >> "$YEAR_PATH/index.mdx"
            echo "$YEARÎÖÑ TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$YEAR_PATH/index.mdx"
            echo "" >> "$YEAR_PATH/index.mdx"
            echo "| Ïõî | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$YEAR_PATH/index.mdx"
            echo "|----|------------------|------------------|" >> "$YEAR_PATH/index.mdx"

            echo '{' > "$YEAR_PATH/_meta.json"
            echo '  "index": "ÏÜåÍ∞ú"' >> "$YEAR_PATH/_meta.json"

            for MONTH_PATH in "$YEAR_PATH"/til-*; do
              MONTH=$(basename "$MONTH_PATH" | cut -d'-' -f2)
              echo "| ${MONTH}Ïõî | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-$YEAR/til-$MONTH) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/tree/main/$YEAR/$MONTH) |" >> "$YEAR_PATH/index.mdx"
              echo '  ,"til-'$MONTH'": "'$MONTH'Ïõî TIL"' >> "$YEAR_PATH/_meta.json"

              echo "# ÏÜåÍ∞ú" > "$MONTH_PATH/index.mdx"
              echo "" >> "$MONTH_PATH/index.mdx"
              echo "${MONTH}ÏõîÏùò TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$MONTH_PATH/index.mdx"
              echo "" >> "$MONTH_PATH/index.mdx"
              echo "| Ï†úÎ™© | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$MONTH_PATH/index.mdx"
              echo "|-------|------------------|------------------|" >> "$MONTH_PATH/index.mdx"

              echo '{' > "$MONTH_PATH/_meta.json"
              echo '  "index": "ÏÜåÍ∞ú"' >> "$MONTH_PATH/_meta.json"

              for FILE in "$MONTH_PATH"/*.mdx; do
                FNAME=$(basename "$FILE" .mdx)
                [ "$FNAME" = "index" ] && continue
                DAY=$(echo "$FNAME" | cut -d'-' -f1)
                TITLE=$(echo "${FNAME:3}" | sed 's/-/ /g')
                echo "| ${DAY}Ïùº $TITLE | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-$YEAR/til-$MONTH/$FNAME) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH/$FNAME.md) |" >> "$MONTH_PATH/index.mdx"
                echo '  ,"'$FNAME'": "'${DAY}Ïùº $TITLE'"' >> "$MONTH_PATH/_meta.json"
              done

              echo "}" >> "$MONTH_PATH/_meta.json"
            done

            echo "}" >> "$YEAR_PATH/_meta.json"
          done

          echo "}" >> "$BASE/_meta.json"

      - name: Convert tags and generate tag index
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          echo '# ÏÜåÍ∞ú

          TIL ÌÉúÍ∑∏ Î™®ÏùåÏûÖÎãàÎã§.

          | ÌÉúÍ∑∏ | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |
          |------|------------------|------------------|' > "$TAGS_DIR/index.mdx"
          echo '{ "index": "ÏÜåÍ∞ú" }' > "$TAGS_DIR/_meta.json"

          for TAG_FILE in "$TAGS_DIR"/*.mdx; do
            TAG=$(basename "$TAG_FILE" .mdx)
            [ "$TAG" = "index" ] && continue
            echo "# üè∑Ô∏è $TAG TIL Î™®Ïùå" > "$TAG_FILE"
            echo "" >> "$TAG_FILE"
            echo "| Ï†úÎ™© | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAG_FILE"
            echo "|-------|------------------|------------------|" >> "$TAG_FILE"

            for FILE in portfolio-repo/src/pages/til/til-*/til-*/*.mdx; do
              FNAME=$(basename "$FILE" .mdx)
              [ "$FNAME" = "index" ] && continue
              if grep -q "tags:.*\b$TAG\b" "$FILE"; then
                YM=$(echo "$FILE" | grep -o 'til-[0-9]*/til-[0-9]*')
                TITLE=$(echo "${FNAME:3}" | sed 's/-/ /g')
                echo "| $TITLE | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/$YM/$FNAME) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/${YM/til-/}/$FNAME.md) |" >> "$TAG_FILE"
              fi
            done

            echo "| $TAG | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/tags/$TAG) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$TAG.md) |" >> "$TAGS_DIR/index.mdx"
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"
          git add .

          CHANGED=$(git status --porcelain | grep -E '^ M|^A|^??' | grep -vE 'tags/.*index.mdx' || true)

          if [ -z "$CHANGED" ]; then
            echo "‚úÖ No actual content changes. Skipping commit."
            exit 0
          fi

          git add .
          git commit -m "üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
