name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches: [main]
    paths: ["**/*.md"]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      hasYears: ${{ steps.set-years.outputs.hasYears }}
      years: ${{ steps.set-years.outputs.years }}

    steps:
      - name: Checkout TIL repository
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Cache til-repo content
        uses: actions/cache@v3
        with:
          path: til-repo
          key: ${{ runner.os }}-tilrepo-${{ hashFiles('til-repo/**/*.md') }}
          restore-keys: |
            ${{ runner.os }}-tilrepo-

      - name: Find TIL years (for matrix)
        id: set-years
        run: |
          YEARS=$(find til-repo -mindepth 1 -maxdepth 1 -type d -regex 'til-repo/[0-9]{4}' | sed 's|til-repo/||')
          echo "YEARS FOUND:"
          echo "$YEARS"

          if [ -z "$YEARS" ]; then
            echo "hasYears=false" >> "$GITHUB_OUTPUT"
            echo "years=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          JSON=$(echo "$YEARS" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "hasYears=true" >> "$GITHUB_OUTPUT"
          echo "years=$JSON" >> "$GITHUB_OUTPUT"

  build-years:
    needs: setup
    if: needs.setup.outputs.hasYears == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        year: ${{ fromJson(needs.setup.outputs.years) }}

    steps:
      - name: Checkout TIL repo
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Sync and convert ${{ matrix.year }}
        run: |
          YEAR=${{ matrix.year }}
          for MONTH in $(find "til-repo/$YEAR" -mindepth 1 -maxdepth 1 -type d -regex "til-repo/$YEAR/[0-9]{2}" -exec basename {} \;); do
            mkdir -p "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH"
            cp til-repo/$YEAR/$MONTH/*.md "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH/" || true
          done

          find portfolio-repo/src/pages/til/til-$YEAR -type f -name "*.md" -exec bash -c 'mv "$0" "${0%.md}.mdx"' {} \;

  finalize:
    needs: build-years
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      # (Ïù¥Ìïò ÏÉùÎûµ: index.mdx, tag ÏÉùÏÑ±, commit/push Îã®Í≥Ñ ÎèôÏùº)
