name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches: [main]
    paths: ["**/*.md"]
  workflow_dispatch:

jobs:
  sync-til:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TIL repo
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Cleanup old TIL pages
        run: |
          rm -rf portfolio-repo/src/pages/til

      - name: Sync and convert TIL files
        run: |
          set -e
          SRC_BASE="til-repo"
          DEST_BASE="portfolio-repo/src/pages/til"

          mkdir -p "$DEST_BASE"

          # tags ÎîîÎ†âÌÜ†Î¶¨Îäî Ï†úÏô∏ÌïòÍ≥† Î≥∏Î¨∏ md ÌååÏùºÎßå Ï≤òÎ¶¨
          find "$SRC_BASE" -type f -name "*.md" ! -path "$SRC_BASE/tags/*" | grep -vE '^til-repo/README\.md$' | while read FILE; do
            REL_PATH="${FILE#$SRC_BASE/}"  # e.g. 2025/07/02-test.md
            YEAR=$(echo "$REL_PATH" | cut -d'/' -f1)
            MONTH=$(echo "$REL_PATH" | cut -d'/' -f2)
            FNAME=$(basename "$REL_PATH" .md)

            DEST_DIR="$DEST_BASE/til-$YEAR/til-$MONTH"
            mkdir -p "$DEST_DIR"
            cp "$FILE" "$DEST_DIR/$FNAME.mdx"
          done

          # ÌÉúÍ∑∏ md ÌååÏùºÎßå Î≥ÑÎèÑ Ï≤òÎ¶¨
          TAGS_SRC="$SRC_BASE/tags"
          TAGS_DEST="$DEST_BASE/tags"
          mkdir -p "$TAGS_DEST"

          shopt -s nullglob
          for FILE in "$TAGS_SRC"/*.md; do
            NAME=$(basename "$FILE" .md)
            cp "$FILE" "$TAGS_DEST/$NAME.mdx"
          done
          shopt -u nullglob

      - name: Create tags/_meta.json and index.mdx
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          mkdir -p "$TAGS_DIR"

          echo '{' > "$TAGS_DIR/_meta.json"
          echo '  "index": "ÏÜåÍ∞ú"' >> "$TAGS_DIR/_meta.json"
          shopt -s nullglob
          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            echo '  ,"'$NAME'": "'$NAME' ÌÉúÍ∑∏"' >> "$TAGS_DIR/_meta.json"
          done
          shopt -u nullglob
          echo "}" >> "$TAGS_DIR/_meta.json"

          echo "# üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå" > "$TAGS_DIR/index.mdx"
          echo "| ÌÉúÍ∑∏ | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAGS_DIR/index.mdx"
          echo "|------|------------------|------------------|" >> "$TAGS_DIR/index.mdx"

          shopt -s nullglob
          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            echo "| $NAME | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/tags/$NAME) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$NAME.md) |" >> "$TAGS_DIR/index.mdx"
          done
          shopt -u nullglob

      - name: Create index.mdx and _meta.json files
        run: |
          BASE="portfolio-repo/src/pages/til"
          mkdir -p "$BASE"
          echo '{' > "$BASE/_meta.json"
          echo '  "index": "ÏÜåÍ∞ú",' >> "$BASE/_meta.json"
          echo '  "tags": "ÌÉúÍ∑∏Î™®Ïùå"' >> "$BASE/_meta.json"

          cat <<EOF > "$BASE/index.mdx"
          # üìì Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ Íæ∏Ï§ÄÌïú ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.

          [üè∑Ô∏è ÌÉúÍ∑∏Î™®Ïùå](/til/tags)

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          EOF

          YEAR_DIRS=$(find "$BASE" -mindepth 1 -maxdepth 1 -type d -regex "$BASE/til-[0-9]{4}" || true)
          if [ -z "$YEAR_DIRS" ]; then
            echo "‚ö†Ô∏è No til-YYYY folders found. Skipping year/month index generation."
            echo "}" >> "$BASE/_meta.json"
            exit 0
          fi

          for YEAR_PATH in $YEAR_DIRS; do
            YEAR=$(basename "$YEAR_PATH" | cut -d'-' -f2)
            echo "- [$YEARÎÖÑ TIL](/til/til-$YEAR)" >> "$BASE/index.mdx"
            echo '  ,"til-'$YEAR'": "'$YEAR'ÎÖÑ TIL"' >> "$BASE/_meta.json"

            echo "# ÏÜåÍ∞ú" > "$YEAR_PATH/index.mdx"
            echo "$YEARÎÖÑ TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$YEAR_PATH/index.mdx"
            echo "| Ïõî | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$YEAR_PATH/index.mdx"
            echo "|----|------------------|------------------|" >> "$YEAR_PATH/index.mdx"

            echo '{' > "$YEAR_PATH/_meta.json"
            echo '  "index": "ÏÜåÍ∞ú"' >> "$YEAR_PATH/_meta.json"

            MONTH_DIRS=$(find "$YEAR_PATH" -mindepth 1 -maxdepth 1 -type d -regex "$YEAR_PATH/til-[0-9]{2}" || true)
            for MONTH_PATH in $MONTH_DIRS; do
              MONTH=$(basename "$MONTH_PATH" | cut -d'-' -f2)
              echo "| ${MONTH}Ïõî | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-$YEAR/til-$MONTH) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/tree/main/$YEAR/$MONTH) |" >> "$YEAR_PATH/index.mdx"
              echo '  ,"til-'$MONTH'": "'$MONTH'Ïõî TIL"' >> "$YEAR_PATH/_meta.json"

              echo "# ÏÜåÍ∞ú" > "$MONTH_PATH/index.mdx"
              echo "${MONTH}ÏõîÏùò TIL Í∏∞Î°ùÏûÖÎãàÎã§." >> "$MONTH_PATH/index.mdx"
              echo "| Ï†úÎ™© | Nextra Î∞îÎ°úÍ∞ÄÍ∏∞ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$MONTH_PATH/index.mdx"
              echo "|-------|------------------|------------------|" >> "$MONTH_PATH/index.mdx"

              echo '{' > "$MONTH_PATH/_meta.json"
              echo '  "index": "ÏÜåÍ∞ú"' >> "$MONTH_PATH/_meta.json"

              shopt -s nullglob
              for FILE in "$MONTH_PATH"/*.mdx; do
                FNAME=$(basename "$FILE" .mdx)
                [ "$FNAME" = "index" ] && continue
                DAY=$(echo "$FNAME" | cut -d'-' -f1)
                TITLE=$(echo "${FNAME:3}" | sed 's/-/ /g')
                echo "| ${DAY}Ïùº $TITLE | [Nextra Î∞îÎ°úÍ∞ÄÍ∏∞](/til/til-$YEAR/til-$MONTH/$FNAME) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH/$FNAME.md) |" >> "$MONTH_PATH/index.mdx"
                echo '  ,"'$FNAME'": "'${DAY}Ïùº $TITLE'"' >> "$MONTH_PATH/_meta.json"
              done
              shopt -u nullglob

              echo "}" >> "$MONTH_PATH/_meta.json"
            done

            echo "}" >> "$YEAR_PATH/_meta.json"
          done

          echo "}" >> "$BASE/_meta.json"

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"
          git add .
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi
          git commit -m "üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
