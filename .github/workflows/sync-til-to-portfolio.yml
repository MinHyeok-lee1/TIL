name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Sync TIL with til- prefix structure
        run: |
          set -e

          mkdir -p portfolio-repo/src/pages/til/

          echo "üìÅ Copying TIL files..."
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

          rename_folder() {
            cd $1
            for year in [0-9][0-9][0-9][0-9]; do
              [ -d "$year" ] || continue
              mv "$year" "til-$year"
              cd "til-$year"
              for month in [0-1][0-9]; do
                [ -d "$month" ] || continue
                mv "$month" "til-$month"
                cd "til-$month"
                for file in *.mdx; do
                  base=$(basename "$file" .mdx)
                  mv "$file" "til-$base.mdx"
                done
                cd ..
              done
              cd ../..
            done
            cd -
          }

          rename_folder portfolio-repo/src/pages/til

          create_meta_index() {
            DIR=$1
            TITLE=$2
            META="$DIR/_meta.json"
            INDEX="$DIR/index.mdx"

            mkdir -p "$DIR"

            echo "# $TITLE" > "$INDEX"
            echo "" >> "$INDEX"
            echo "$TITLE ÏÜåÍ∞ú ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX"

            echo "{" > "$META"
            echo '  "index": "ÏÜåÍ∞ú",' >> "$META"

            for sub in $(find "$DIR" -mindepth 1 -maxdepth 1 -type d | sort); do
              key=$(basename "$sub")
              label=$(echo "$key" | sed 's/til-\([0-9][0-9][0-9][0-9]\)/\1\ub144 TIL/' | sed 's/til-\([0-9][0-9]\)/\1Ïõî TIL/')
              echo "  \"$key\": \"$label\"," >> "$META"
            done

            for file in $(find "$DIR" -maxdepth 1 -type f -name 'til-*.mdx' | sort); do
              name=$(basename "$file" .mdx)
              title=$(grep '^title:' "$file" | cut -d ':' -f2- | xargs)
              day=${name#til-}; day=${day%%-*}
              echo "  \"$name\": \"${day}\uc77c $title\"," >> "$META"
            done

            sed -i '$ s/,$//' "$META"
            echo "}" >> "$META"
          }

          create_index_page() {
            INDEX_PATH="portfolio-repo/src/pages/til/index.mdx"
            mkdir -p $(dirname "$INDEX_PATH")
            cat <<EOF > "$INDEX_PATH"
            # Today I Learned (TIL)

            > ÍΩ§Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
            Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

            ## üìÖ Ïó∞ÎèÑÎ≥Ñ

            - [2025Ïó∞ 6Ïõî](/til/til-2025/til-06)
            - [üçøÔ∏è ÌÉúÍ∑∏ Î™©Î°ù](/til/tags)
            EOF
          }

          create_index_page
          create_meta_index portfolio-repo/src/pages/til "üìì TIL ÏÜåÍ∞ú"

          for year in portfolio-repo/src/pages/til/til-*; do
            [ -d "$year" ] || continue
            create_meta_index "$year" "üìÖ $(basename $year | cut -d '-' -f2)ÎÖÑ TIL"
            for month in "$year"/til-*; do
              [ -d "$month" ] || continue
              create_meta_index "$month" "üóìÔ∏è $(basename $year | cut -d '-' -f2)ÎÖÑ $(basename $month | cut -d '-' -f2)Ïõî TIL"
            done
          done

          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          TAGS_META="$TAGS_DIR/_meta.json"
          TAGS_INDEX="$TAGS_DIR/index.mdx"

          if [ -d "$TAGS_DIR" ]; then
            echo "{" > "$TAGS_META"
            echo '  "index": "ÏÜåÍ∞ú",' >> "$TAGS_META"

            cat <<EOF > "$TAGS_INDEX"
            # üéüÔ∏è ÌÉúÍ∑∏ Î™©Î°ù

            TILÏùò ÌÉúÍ∑∏Î≥Ñ Î∂ÑÎ•òÏûÖÎãàÎã§.

            | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |
            | --- | --- |
            EOF

            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)
              echo "  \"$tag\": \"\ud0dc\uadf8 \ubaa9\ub85d\"," >> "$TAGS_META"
              echo "| [$tag](/til/tags/$tag.md) | [\ud83d\udd17 GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_INDEX"

              cat <<EOF > "$tag_file"
              # $tag ÌÉúÍ∑∏ Î¨∏ÏÑú

              ## üìò Nextra Ï†ïÎ¶¨
              EOF
              grep -rl "tags: \[.*$tag.*\]" portfolio-repo/src/pages/til | grep .mdx | while read path; do
                title=$(grep '^title:' "$path" | cut -d ':' -f2- | xargs)
                rel_path=$(echo "$path" | sed 's|portfolio-repo/src/pages||' | sed 's|.mdx$||')
                echo "- [$title]($rel_path)" >> "$tag_file"
              done

              cat <<EOF >> "$tag_file"

              ## üîó GitHub ÏõπÎ¨¥Îã¥
              - [GitHubÎ°ú Î≥¥Í∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md)
              EOF
            done

            sed -i '$ s/,$//' "$TAGS_META"
            echo "}" >> "$TAGS_META"
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git commit -m "$COMMIT_MSG"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
