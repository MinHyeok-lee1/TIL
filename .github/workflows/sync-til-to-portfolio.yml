name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Generate _meta.json, index.mdx and tag contents
        run: |
          echo "üìÅ Generating _meta.json, index.mdx and tag contents..."

          TIL_DIR="portfolio-repo/src/pages/til"

          rm -rf "$TIL_DIR/20*"

          localize_name() {
            case "$1" in
              til-2025) echo "2025ÎÖÑ TIL";;
              til-06) echo "06Ïõî TIL";;
              til-07) echo "07Ïõî TIL";;
              til-24-*) echo "24Ïùº ${1#til-24-}";;
              til-25-*) echo "25Ïùº ${1#til-25-}";;
              til-26-*) echo "26Ïùº ${1#til-26-}";;
              *) echo "$1";;
            esac
          }

          create_meta_and_index() {
            DIR=$1
            TITLE=$2
            INDEX_FILE="$DIR/index.mdx"
            META_FILE="$DIR/_meta.json"

            mkdir -p "$DIR"
            echo "# $TITLE" > "$INDEX_FILE"
            echo >> "$INDEX_FILE"
            echo "$TITLE ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX_FILE"

            echo "{" > "$META_FILE"
            echo '  "index": "ÏÜåÍ∞ú",' >> "$META_FILE"

            for entry in "$DIR"/*; do
              name=$(basename "$entry")
              case "$name" in
                index.mdx|_meta.json) continue;;
              esac
              key="${name%.mdx}"
              label=$(localize_name "$key")
              echo "  \"$key\": \"$label\"," >> "$META_FILE"
            done

            sed -i '$ s/,$//' "$META_FILE" || sed -i '' '$ s/,$//' "$META_FILE"
            echo "}" >> "$META_FILE"
          }

          # til/index.mdx Í≥†Ï†ï ÏÉùÏÑ±
          TIL_INDEX="$TIL_DIR/index.mdx"
          cat <<EOF > "$TIL_INDEX"
          # Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
          Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)
          - [2025ÎÖÑ TIL](/til/til-2025)
          EOF

          create_meta_and_index "$TIL_DIR" "üìö TIL Î™®Ïùå"

          # til Íµ¨Ï°∞ Î∞òÏòÅ (Ïó∞ÎèÑ/Ïõî/Ïùº)
          for year_dir in til-repo/[0-9][0-9][0-9][0-9]; do
            [ -d "$year_dir" ] || continue
            year=$(basename "$year_dir")
            target_year_dir="$TIL_DIR/til-$year"
            mkdir -p "$target_year_dir"

            for month_dir in "$year_dir"/*; do
              [ -d "$month_dir" ] || continue
              month=$(basename "$month_dir")
              target_month_dir="$target_year_dir/til-$month"
              mkdir -p "$target_month_dir"

              for file in "$month_dir"/*.md; do
                [ -f "$file" ] || continue
                base=$(basename "$file" .md)
                title=$(awk -F': ' '/^title:/ {print $2}' "$file")
                slug="til-${base,,}"
                cp "$file" "$target_month_dir/$slug.mdx"
                echo "# $title" > "$target_month_dir/$slug.mdx"
              done

              create_meta_and_index "$target_month_dir" "üóìÔ∏è ${year}ÎÖÑ ${month}Ïõî TIL"
            done

            create_meta_and_index "$target_year_dir" "üìÖ ${year}ÎÖÑ TIL"
          done

          # tags index ÏÉùÏÑ±
          TAGS_DIR="$TIL_DIR/tags"
          mkdir -p "$TAGS_DIR"
          TAGS_INDEX="$TAGS_DIR/index.mdx"
          TAGS_META="$TAGS_DIR/_meta.json"

          echo "# üè∑Ô∏è ÌÉúÍ∑∏ Î™©Î°ù" > "$TAGS_INDEX"
          echo >> "$TAGS_INDEX"
          echo "| ÌÉúÍ∑∏ | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAGS_INDEX"
          echo "|------|----------------|------------------|" >> "$TAGS_INDEX"

          echo '{' > "$TAGS_META"
          echo '  "index": "ÏÜåÍ∞ú",' >> "$TAGS_META"

          for tag_file in til-repo/tags/*.md; do
            [ -f "$tag_file" ] || continue
            tag=$(basename "$tag_file" .md)
            echo "  \"$tag\": \"$tag\"," >> "$TAGS_META"

            echo "# $tag ÌÉúÍ∑∏ Î¨∏ÏÑú" > "$TAGS_DIR/$tag.mdx"
            echo >> "$TAGS_DIR/$tag.mdx"
            echo "## üìò Nextra Ï†ïÎ¶¨" >> "$TAGS_DIR/$tag.mdx"

            grep -rl "$tag" "$TIL_DIR/til-2025" | grep .mdx | while read f; do
              label=$(awk -F'# ' '/^# / {print $2; exit}' "$f")
              link="${f#portfolio-repo/src/pages}" # strip path
              echo "- [$label]($link)" >> "$TAGS_DIR/$tag.mdx"
            done

            echo >> "$TAGS_DIR/$tag.mdx"
            echo "## üîó GitHub ÏõêÎ≥∏" >> "$TAGS_DIR/$tag.mdx"
            echo "- [GitHubÎ°ú Î≥¥Í∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md)" >> "$TAGS_DIR/$tag.mdx"

            echo "| $tag | [Î∞îÎ°úÍ∞ÄÍ∏∞](/til/tags/$tag) | [üîó GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_INDEX"
          done

          sed -i '$ s/,$//' "$TAGS_META" || sed -i '' '$ s/,$//' "$TAGS_META"
          echo "}" >> "$TAGS_META"

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git commit -m "$COMMIT_MSG"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
