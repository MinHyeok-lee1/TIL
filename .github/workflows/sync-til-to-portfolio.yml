name: 🔄 Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch: # ✅ 수동 실행 지원

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Create structured folders and index/meta
        run: |
          echo "📁 Restructuring TIL folders and generating index/meta files..."

          cd portfolio-repo/src/pages/til

          # ❌ 이전 공속 파일 제거
          rm -rf [0-9][0-9][0-9][0-9]

          # ✅ 1. 연도별 파일/폴더 이름 til-YYYY/til-MM
          for filepath in $(find . -type f -name "*.mdx" ! -path "*/tags/*"); do
            year=$(echo "$filepath" | grep -oE '\d{4}')
            month=$(echo "$filepath" | grep -oE '/(0[1-9]|1[0-2])/' | tr -d '/')
            mkdir -p til-${year}/til-${month}
            mv "$filepath" til-${year}/til-${month}/
          done

          # ✅ 2. til/가지 소개 페이지와 meta 생성
          cat <<EOF > index.mdx
          # Today I Learned (TIL)

          > 꿔준한 기록은 최고의 성장으로 이어지는다.  
          개발/임베딘드/도구에 대한 학습 기록을 정리합니다.

          ## 📅 연도별

          - [2025년 6월](/til/til-2025/til-06)
          - [🏷️ 태그 목록](/til/tags)
          EOF

          echo '{ "index": { "display": "hidden" }, "til-2025": "2025 TIL", "tags": "태그" }' > _meta.json

          # ✅ 3. 년/6월/값에 따른 meta/index 생성
          for year_dir in til-*; do
            [ -d "$year_dir" ] || continue
            echo '{ "index": { "display": "hidden" },' > "$year_dir/_meta.json"
            for month_dir in "$year_dir"/til-*; do
              [ -d "$month_dir" ] || continue
              month=$(basename "$month_dir")
              echo "  \"$month\": \"${month#til-}\uc6d4 TIL\"," >> "$year_dir/_meta.json"
              echo "# 🗓️ ${month#til-}월 TIL" > "$month_dir/index.mdx"
            done
            sed -i '$ s/,$//' "$year_dir/_meta.json" || sed -i '' '$ s/,$//' "$year_dir/_meta.json"
            echo '}' >> "$year_dir/_meta.json"
            echo "# 🗓️ ${year_dir#til-}년 TIL" > "$year_dir/index.mdx"
          done

          # ✅ 4. tags 페이지 변경
          TAGS_DIR="tags"
          echo '{ "index": { "display": "hidden" },' > "$TAGS_DIR/_meta.json"
          echo "# 🏷️ 태그 목록\n\nTIL의 태그별 분류입니다. GitHub 원본과 내부 보기 모드 전달\n" > "$TAGS_DIR/index.mdx"

          for tag_file in "$TAGS_DIR"/*.md; do
            [ -f "$tag_file" ] || continue
            tag=$(basename "$tag_file" .md)
            echo "  \"$tag\": \"$tag\"," >> "$TAGS_DIR/_meta.json"
            echo "- [📘 $tag](/til/tags/$tag)  [🔗 GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md)" >> "$TAGS_DIR/index.mdx"
          done
          sed -i '$ s/,$//' "$TAGS_DIR/_meta.json" || sed -i '' '$ s/,$//' "$TAGS_DIR/_meta.json"
          echo '}' >> "$TAGS_DIR/_meta.json"

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="📝 Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          변경된 파일 수: $FILE_COUNT개

          변경된 파일 목록:
          $FILE_LIST
          EOF
          )
          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "⚠️ Git push failed"; exit 1; }
