name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Sync and Build
        run: |
          set -e

          mkdir -p portfolio-repo/src/pages/til/

          echo "\ud83d\udcc1 Copying TIL files..."
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

          localize_name() {
            case "$1" in
              til-2025) echo "2025\ub144 TIL" ;;
              til-06) echo "06\uc6d4 TIL" ;;
              til-07) echo "07\uc6d4 TIL" ;;
              *) echo "$1" ;;
            esac
          }

          get_day_title() {
            file="$1"
            title=$(grep '^title:' "$file" | cut -d ':' -f2- | xargs)
            day=${file##*/}; day=${day%%-*}
            echo "${day}\uc77c ${title}"
          }

          create_meta_and_index() {
            DIR=$1
            META_FILE="$DIR/_meta.json"
            INDEX_FILE="$DIR/index.mdx"
            TITLE="$2"

            echo "# $TITLE" > "$INDEX_FILE"
            echo "" >> "$INDEX_FILE"
            echo "$TITLE ÏÜåÍ∞ú ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX_FILE"

            folders=$(find "$DIR" -mindepth 1 -maxdepth 1 -type d | sort || true)
            files=$(find "$DIR" -mindepth 1 -maxdepth 1 -type f -name '*.mdx' ! -name 'index.mdx' | sort || true)

            echo "{" > "$META_FILE"
            echo '  "index": "ÏÜåÍ∞ú",' >> "$META_FILE"

            for path in $folders; do
              name=$(basename "$path")
              label=$(localize_name "$name")
              echo "  \"$name\": \"$label\"," >> "$META_FILE"
            done

            for file in $files; do
              name=$(basename "$file" .mdx)
              label=$(get_day_title "$file")
              echo "  \"$name\": \"$label\"," >> "$META_FILE"
            done

            sed -i '$ s/,$//' "$META_FILE" || sed -i '' '$ s/,$//' "$META_FILE"
            echo "}" >> "$META_FILE"
          }

          cd portfolio-repo/src/pages/til

          # Ï†ïÎ¶¨: til-06 Ïú†ÏßÄ, Í∑∏ Ïô∏ 06 Ìè¥Îçî Ï†úÍ±∞
          for year in [0-9][0-9][0-9][0-9]; do
            [ -d "$year" ] || continue
            mv "$year" "til-$year"
          done

          for dir in til-*; do
            [ -d "$dir" ] || continue
            cd "$dir"
            for month in [0-1][0-9]; do
              [ -d "$month" ] && rm -rf "$month"
            done
            cd ..
          done

          cd ../../../..

          # Í≥†Ï†ï TIL index ÏÉùÏÑ±
          cat <<EOF > portfolio-repo/src/pages/til/index.mdx
          # \ud83d\udcd3 Today I Learned (TIL)

          > \uafd4\uc900\ud55c \uae30\ub85d\uc740 \ucc38\uc6b0\uc758 \uc131\uc7a5\uc73c\ub85c \uc774\uc5b4\uc9c4\ub2e4.  
          \uac1c\ubc1c/\uc784\ubca0\ub518\ub4dc/\ub3c4\uad6c\uc5d0 \ub300\ud55c \ud559\uc2b5 \uae30\ub85d\uc744 \uc815\ub9ac\ud569\ub2c8\ub2e4.

          ## \ud83d\udcc5 \uc5f0\ub3d9\ubcc4

          - [2025\ub144 6\uc6d4](/til/til-2025/til-06)
          - [\ud83c\udf7f\ufe0f \ud0dc\uadf8 \ubaa9\ub85d](/til/tags)
          EOF

          # Î©îÌÉÄ Î∞è Ïù∏Îç±Ïä§ ÏÉùÏÑ±
          create_meta_and_index "portfolio-repo/src/pages/til" "\ud83d\udcd3 TIL ÏÜåÍ∞ú"

          for ydir in portfolio-repo/src/pages/til/til-*; do
            [ -d "$ydir" ] || continue
            ybase=$(basename "$ydir")
            create_meta_and_index "$ydir" "$(localize_name "$ybase")"

            for mdir in "$ydir"/til-*; do
              [ -d "$mdir" ] || continue
              mbase=$(basename "$mdir")
              create_meta_and_index "$mdir" "$(localize_name "$mbase")"
            done
          done

          # ÌÉúÍ∑∏ Ï≤òÎ¶¨
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          TAGS_META="$TAGS_DIR/_meta.json"
          TAGS_INDEX="$TAGS_DIR/index.mdx"

          if [ -d "$TAGS_DIR" ]; then
            echo "{" > "$TAGS_META"
            echo '  "index": "ÏÜåÍ∞ú",' >> "$TAGS_META"
            echo '  "tags": "ÌÉúÍ∑∏ Î™®Ïùå"' >> "$TAGS_META"
            echo "}" >> "$TAGS_META"

            echo "# \ud83c\udf9f\ufe0f \ud0dc\uadf8 \ubaa9\ub85d" > "$TAGS_INDEX"
            echo "" >> "$TAGS_INDEX"
            echo "TILÏùò ÌÉúÍ∑∏Î≥Ñ Î∂ÑÎ•òÏûÖÎãàÎã§." >> "$TAGS_INDEX"
            echo "" >> "$TAGS_INDEX"
            echo "| Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAGS_INDEX"
            echo "| --- | --- |" >> "$TAGS_INDEX"

            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)
              echo "| [$tag](/til/tags/$tag.md) | [üîó GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_INDEX"
              echo "# $tag ÌÉúÍ∑∏ Î¨∏ÏÑú" > "$tag_file"
              echo "" >> "$tag_file"
              echo "## üìò Nextra Ï†ïÎ¶¨" >> "$tag_file"

              grep -rl "tags: \[.*$tag.*\]" portfolio-repo/src/pages/til | grep .mdx | while read path; do
                title=$(grep '^title:' "$path" | cut -d ':' -f2- | xargs)
                rel_path=$(echo "$path" | sed 's|portfolio-repo/src/pages||')
                echo "- [$title]($rel_path)" >> "$tag_file"
              done

              echo "" >> "$tag_file"
              echo "## üîó GitHub ÏõêÎ≥∏" >> "$tag_file"
              echo "- [GitHubÎ°ú Î≥¥Í∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md)" >> "$tag_file"
            done
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"
          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          COMMIT_MSG="\ud83d\udcdd Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git commit -m "$COMMIT_MSG"
          git push || { echo "\u26a0\ufe0f Git push failed"; exit 1; }
