name: ğŸ”„ Sync TIL to Portfolio

on:
  push:
    branches: [main]
    paths: ["**/*.md"]
  workflow_dispatch:

jobs:
  sync-til:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TIL repo
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Cleanup old TIL pages
        run: |
          rm -rf portfolio-repo/src/pages/til

      - name: Sync and convert TIL files
        run: |
          set -e
          SRC_BASE="til-repo"
          DEST_BASE="portfolio-repo/src/pages/til"

          mkdir -p "$DEST_BASE"

          find "$SRC_BASE" -type f -name "*.md" ! -path "$SRC_BASE/tags/*" | grep -vE '^til-repo/README\.md$' | while read FILE; do
            REL_PATH="${FILE#$SRC_BASE/}"
            YEAR=$(echo "$REL_PATH" | cut -d'/' -f1)
            MONTH=$(echo "$REL_PATH" | cut -d'/' -f2)
            FNAME=$(basename "$REL_PATH" .md)

            [[ "$YEAR" =~ ^[0-9]{4}$ ]] || continue
            [[ "$MONTH" =~ ^[0-9]{2}$ ]] || continue

            mkdir -p "$DEST_BASE/til-$YEAR"
            DEST_DIR="$DEST_BASE/til-$YEAR/til-$MONTH"
            mkdir -p "$DEST_DIR"
            cp "$FILE" "$DEST_DIR/$FNAME.mdx"
          done

          TAGS_SRC="$SRC_BASE/tags"
          TAGS_DEST="$DEST_BASE/tags"
          mkdir -p "$TAGS_DEST"

          shopt -s nullglob
          for FILE in "$TAGS_SRC"/*.md; do
            NAME=$(basename "$FILE" .md)
            cp "$FILE" "$TAGS_DEST/$NAME.mdx"
          done
          shopt -u nullglob

      - name: Create tags/_meta.json and index.mdx
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          mkdir -p "$TAGS_DIR"

          echo '{' > "$TAGS_DIR/_meta.json"
          echo '  "index": "ë¬¸ì„œê°œìš”"' >> "$TAGS_DIR/_meta.json"
          FIRST=1
          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            [ "$NAME" = "index" ] && continue    # index.mdxëŠ” metaì— ì¶”ê°€ X
            if [ $FIRST -eq 1 ]; then
              echo '  ,"'$NAME'": "'$NAME' íƒœê·¸"' >> "$TAGS_DIR/_meta.json"
              FIRST=0
            else
              echo '  ,"'$NAME'": "'$NAME' íƒœê·¸"' >> "$TAGS_DIR/_meta.json"
            fi
          done
          echo "}" >> "$TAGS_DIR/_meta.json"

          echo "# ğŸ·ï¸ íƒœê·¸ ëª¨ìŒ" > "$TAGS_DIR/index.mdx"
          echo "| íƒœê·¸ | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$TAGS_DIR/index.mdx"
          echo "|------|------------------|------------------|" >> "$TAGS_DIR/index.mdx"

          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            [ "$NAME" = "index" ] && continue
            echo "| $NAME | [Nextra ë°”ë¡œê°€ê¸°](/til/tags/$NAME) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$NAME.md) |" >> "$TAGS_DIR/index.mdx"
          done

      - name: Create all _meta.json and index.mdx files
        run: |
          BASE="portfolio-repo/src/pages/til"

          # til/_meta.json
          echo "{" > "$BASE/_meta.json"
          echo '  "index": "ë¬¸ì„œê°œìš”",' >> "$BASE/_meta.json"
          echo '  "tags": "íƒœê·¸ëª¨ìŒ"' >> "$BASE/_meta.json"
          YEARS=()
          for YEAR_DIR in "$BASE"/til-*; do
            [ -d "$YEAR_DIR" ] || continue
            YEARS+=("$(basename "$YEAR_DIR" | cut -d'-' -f2)")
          done
          for YEAR in "${YEARS[@]}"; do
            echo '  ,"til-'"$YEAR"'": "'"$YEAR"'ë…„ TIL"' >> "$BASE/_meta.json"
          done
          echo "}" >> "$BASE/_meta.json"

          # tags/_meta.json, tags/index.mdx
          TAGS_DIR="$BASE/tags"
          mkdir -p "$TAGS_DIR"
          # tags/_meta.json (indexê°€ í•­ìƒ ì²« ì¤„)
          {
            echo '{'
            echo '  "index": "ë¬¸ì„œê°œìš”"'
            FIRST=1
            for FILE in "$TAGS_DIR"/*.mdx; do
              [ -f "$FILE" ] || continue
              NAME=$(basename "$FILE" .mdx)
              [ "$NAME" = "index" ] && continue
              if [ $FIRST -eq 1 ]; then
                echo -n ",\n  \"${NAME}\": \"${NAME} íƒœê·¸\""
                FIRST=0
              else
                echo -n ",\n  \"${NAME}\": \"${NAME} íƒœê·¸\""
              fi
            done
            echo -e "\n}"
          } > "$TAGS_DIR/_meta.json"

          echo "# ğŸ·ï¸ íƒœê·¸ ëª¨ìŒ" > "$TAGS_DIR/index.mdx"
          echo "| íƒœê·¸ | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$TAGS_DIR/index.mdx"
          echo "|------|------------------|------------------|" >> "$TAGS_DIR/index.mdx"
          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            [ "$NAME" = "index" ] && continue
            echo "| $NAME | [Nextra ë°”ë¡œê°€ê¸°](/til/tags/$NAME) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$NAME.md) |" >> "$TAGS_DIR/index.mdx"
          done

          # til index.mdx
          echo "# ğŸ““ Today I Learned (TIL)" > "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "> ê¾¸ì¤€í•œ ê¸°ë¡ì€ ìµœê³ ì˜ ì„±ì¥ìœ¼ë¡œ ì´ì–´ì§„ë‹¤." >> "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "[ğŸ·ï¸ íƒœê·¸ëª¨ìŒ](/til/tags)" >> "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "## ğŸ“… ì—°ë„ë³„" >> "$BASE/index.mdx"
          for YEAR in "${YEARS[@]}"; do
            echo "- [${YEAR}ë…„ TIL](/til/til-$YEAR)" >> "$BASE/index.mdx"
          done

          # til-YYYY/_meta.json, til-YYYY/index.mdx
          for YEAR in "${YEARS[@]}"; do
            YEAR_DIR="$BASE/til-$YEAR"

            # til-YYYY/_meta.json
            {
              echo '{'
              echo '  "index": "ë¬¸ì„œê°œìš”"'
              FIRST=1
              for MONTH_DIR in "$YEAR_DIR"/til-*; do
                [ -d "$MONTH_DIR" ] || continue
                MONTH=$(basename "$MONTH_DIR" | cut -d'-' -f2)
                if [ $FIRST -eq 1 ]; then
                  echo -n ",\n  \"til-$MONTH\": \"${MONTH}ì›” TIL\""
                  FIRST=0
                else
                  echo -n ",\n  \"til-$MONTH\": \"${MONTH}ì›” TIL\""
                fi
              done
              echo -e "\n}"
            } > "$YEAR_DIR/_meta.json"

            # til-YYYY/index.mdx (í‘œë¡œ ì›”ë³„ ë§í¬)
            echo "# ë¬¸ì„œê°œìš”" > "$YEAR_DIR/index.mdx"
            echo "${YEAR}ë…„ TIL ê¸°ë¡ì…ë‹ˆë‹¤." >> "$YEAR_DIR/index.mdx"
            echo "| ì›” | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$YEAR_DIR/index.mdx"
            echo "|----|------------------|------------------|" >> "$YEAR_DIR/index.mdx"
            for MONTH_DIR in "$YEAR_DIR"/til-*; do
              [ -d "$MONTH_DIR" ] || continue
              MONTH=$(basename "$MONTH_DIR" | cut -d'-' -f2)
              echo "| ${MONTH}ì›” | [Nextra ë°”ë¡œê°€ê¸°](/til/til-$YEAR/til-$MONTH) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH) |" >> "$YEAR_DIR/index.mdx"
            done

            # til-YYYY/til-MM/_meta.json, til-YYYY/til-MM/index.mdx
            for MONTH_DIR in "$YEAR_DIR"/til-*; do
              [ -d "$MONTH_DIR" ] || continue
              MONTH=$(basename "$MONTH_DIR" | cut -d'-' -f2)

              # til-YYYY/til-MM/_meta.json
              {
                echo '{'
                echo '  "index": "ë¬¸ì„œê°œìš”"'
                FIRST_FILE=1
                FILES=( "$MONTH_DIR"/*.mdx )
                for FILE in "${FILES[@]}"; do
                  [ -f "$FILE" ] || continue
                  FNAME=$(basename "$FILE" .mdx)
                  [ "$FNAME" = "index" ] && continue
                  DAY=$(echo "$FNAME" | cut -d'-' -f1)
                  TITLE_CLEAN=$(echo "$FNAME" | cut -d'-' -f2- | sed 's/-/ /g')
                  if [ $FIRST_FILE -eq 1 ]; then
                    echo -n ",\n  \"${FNAME}\": \"${DAY}ì¼ ${TITLE_CLEAN}\""
                    FIRST_FILE=0
                  else
                    echo -n ",\n  \"${FNAME}\": \"${DAY}ì¼ ${TITLE_CLEAN}\""
                  fi
                done
                echo -e "\n}"
              } > "$MONTH_DIR/_meta.json"

              # til-YYYY/til-MM/index.mdxëŠ” ê¸°ì¡´ëŒ€ë¡œ
            done
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"
          git add .
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi
          git commit -m "ğŸ“ Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
