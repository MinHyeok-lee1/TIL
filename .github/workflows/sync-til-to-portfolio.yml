name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch: # ‚úÖ ÏàòÎèô Ïã§Ìñâ ÏßÄÏõê

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" -print0 | while IFS= read -r -d '' file; do
            new_file="${file%.md}.mdx"
            mv "$file" "$new_file"
          done

      - name: Move 2025 ‚Üí til-2025
        run: |
          base_dir="portfolio-repo/src/pages/til"
          if [ -d "$base_dir/2025" ]; then
            rm -rf "$base_dir/til-2025"
            mv "$base_dir/2025" "$base_dir/til-2025"
          fi

      - name: Create all index.mdx and _meta.json
        run: |
          base_dir="portfolio-repo/src/pages/til"

          # 1. ÏµúÏÉÅÏúÑ index.mdx
          mkdir -p "$base_dir"
          cat <<EOF > "$base_dir/index.mdx"
          # üìì Today I Learned (TIL)

          > Íæ∏Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
          Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå](/til/tags)
          - [2025ÎÖÑ 6Ïõî](/til/til-2025/til-06)
          EOF

          # 2. til-2025 index.mdx + _meta.json
          mkdir -p "$base_dir/til-2025"
          echo -e "# ÏÜåÍ∞ú\n\nÏù¥ Ìè¥ÎçîÎäî Ï†ïÎ¶¨Îêú TIL Î¨∏ÏÑúÎ•º Ìè¨Ìï®ÌïòÍ≥† ÏûàÏäµÎãàÎã§." > "$base_dir/til-2025/index.mdx"
          echo '{ "index": "ÏÜåÍ∞ú", "til-06": "06Ïõî TIL" }' > "$base_dir/til-2025/_meta.json"

          # 3. til-06 index.mdx + _meta.json
          mkdir -p "$base_dir/til-2025/til-06"
          echo -e "# ÏÜåÍ∞ú\n\nÏù¥ Ìè¥ÎçîÎäî Ï†ïÎ¶¨Îêú TIL Î¨∏ÏÑúÎ•º Ìè¨Ìï®ÌïòÍ≥† ÏûàÏäµÎãàÎã§." > "$base_dir/til-2025/til-06/index.mdx"

          echo '{' > "$base_dir/til-2025/til-06/_meta.json"
          echo '  "index": "ÏÜåÍ∞ú",' >> "$base_dir/til-2025/til-06/_meta.json"
          find "$base_dir/til-2025/til-06" -type f -name "*.mdx" | while read file; do
            fname=$(basename "$file" .mdx)
            day=${fname:0:2}
            title=$(echo "${fname:3}" | sed 's/-/ /g' | sed -E 's/(^| )(\w)/\U\\2/g')
            echo "  \"$fname\": \"$dayÏùº $title\"," >> "$base_dir/til-2025/til-06/_meta.json"
          done
          sed -i '$ s/,$//' "$base_dir/til-2025/til-06/_meta.json"
          echo '}' >> "$base_dir/til-2025/til-06/_meta.json"

      - name: Generate _meta.json and tag index.mdx with summaries
        run: |
          tags_dir="portfolio-repo/src/pages/til/tags"
          til_path="portfolio-repo/src/pages/til/til-2025/til-06"

          # ‚úÖ ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùÑ Í≤ΩÏö∞ ÏÉùÏÑ±
          mkdir -p "$tags_dir"

          # 0. tags ÎîîÎ†âÌÜ†Î¶¨ index.mdx ÏÉùÏÑ±
          index_file="$tags_dir/index.mdx"
          echo "# üè∑Ô∏è ÌÉúÍ∑∏ Î™®Ïùå" > "$index_file"
          echo "" >> "$index_file"
          echo "Ï£ºÏöî ÌÉúÍ∑∏Î≥Ñ TIL Î™®ÏùåÏûÖÎãàÎã§. Í∞Å Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏÑ∏Î∂Ä ÎÇ¥Ïö©ÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§." >> "$index_file"
          echo "" >> "$index_file"
          echo "| ÌÉúÍ∑∏ | Nextra Ï†ïÎ¶¨ | GitHub ÏõêÎ≥∏ |" >> "$index_file"
          echo "|------|----------------|------------------|" >> "$index_file"

          # 1. tags ÎîîÎ†âÌÜ†Î¶¨ _meta.json
          echo '{ "index": "ÌÉúÍ∑∏ Î™®Ïùå" }' > "$tags_dir/_meta.json"

          # 2. ÌÉúÍ∑∏Î≥Ñ ÏÑ∏Î∂Ä mdx ÌååÏùº ÏÉùÏÑ±
          if [ -d "$til_path" ] && compgen -G "$til_path/*.mdx" > /dev/null; then
            for tag_file in "$tags_dir"/*.mdx; do
              tag=$(basename "$tag_file" .mdx)
              tag_title=$(echo "$tag" | sed -E 's/(^| )(\w)/\U\\2/g')
              nextra_link="/til/tags/$tag"
              github_link="https://github.com/MinHyeok-lee1/TIL/tree/main/src/pages/til/tags"

              # index.mdxÏóê ÏöîÏïΩ Ï∂îÍ∞Ä
              echo "| $tag_title | [$nextra_link]($nextra_link) | [GitHub]($github_link) |" >> "$index_file"

              # ÏÑ∏Î∂Ä mdx ÌååÏùº Ï¥àÍ∏∞Ìôî
              echo "# üè∑Ô∏è $tag_title TIL Î™®Ïùå" > "$tag_file"
              echo "" >> "$tag_file"
              echo "| Ï†úÎ™© | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$tag_file"
              echo "|------|--------------|------------------|" >> "$tag_file"

              for file in "$til_path"/*.mdx; do
                if grep -q "tags:.*$tag" "$file"; then
                  fname=$(basename "$file" .mdx)
                  title=$(echo "${fname:3}" | sed 's/-/ /g' | sed -E 's/(^| )(\w)/\U\\2/g')
                  nextra="/til/til-2025/til-06/$fname"
                  github="https://github.com/MinHyeok-lee1/TIL/blob/main/src/pages/til/til-2025/til-06/$fname.mdx"
                  echo "| $title | [$nextra]($nextra) | [GitHub]($github) |" >> "$tag_file"
                fi
              done
            done
          else
            echo "No .mdx files found in $til_path. Skipping tag table generation."
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò: $FILE_COUNTÍ∞ú

          Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:
          $FILE_LIST
          EOF
          )
          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
