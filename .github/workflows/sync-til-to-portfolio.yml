name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch: # ‚úÖ ÏàòÎèô Ïã§Ìñâ ÏßÄÏõê

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Create _meta.json and index.mdx files
        run: |
          echo "üìÅ Generating _meta.json and index.mdx files..."

          # üìå label Î≥ÄÌôò Ìï®Ïàò
          get_label() {
            case "$1" in
              index) echo "Î™©Ï∞®" ;;
              tags) echo "ÌÉúÍ∑∏ Î™®Ïùå" ;;
              01) echo "1Ïõî TIL" ;; 02) echo "2Ïõî TIL" ;;
              03) echo "3Ïõî TIL" ;; 04) echo "4Ïõî TIL" ;;
              05) echo "5Ïõî TIL" ;; 06) echo "6Ïõî TIL" ;;
              07) echo "7Ïõî TIL" ;; 08) echo "8Ïõî TIL" ;;
              09) echo "9Ïõî TIL" ;; 10) echo "10Ïõî TIL" ;;
              11) echo "11Ïõî TIL" ;; 12) echo "12Ïõî TIL" ;;
              202[0-9]) echo "$1 TIL" ;;
              *) echo "$1" ;;
            esac
          }

          # üîÅ _meta.jsonÍ≥º index.mdx Ï†ÑÏ≤¥ Í≤ΩÎ°ú Ïû¨ÏàúÌöå
          find portfolio-repo/src/pages/til -type d | while read dir; do
            INDEX_FILE="$dir/index.mdx"
            META_FILE="$dir/_meta.json"
            DIRNAME=$(basename "$dir")
            LABEL=$(get_label "$DIRNAME")

            # ‚úÖ index.mdx ÏÉùÏÑ±
            if [ ! -f "$INDEX_FILE" ]; then
              echo "# üìò $LABEL" > "$INDEX_FILE"
              echo "" >> "$INDEX_FILE"
              echo "$LABEL ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX_FILE"
            fi

            # ‚úÖ _meta.json ÏÉùÏÑ±
            subdirs=$(find "$dir" -mindepth 1 -maxdepth 1 -type d -exec basename {} \;)
            files=$(find "$dir" -maxdepth 1 -type f -name "*.mdx" -exec basename {} .mdx \; | grep -v "^index$")

            {
              echo "{"
              echo "  \"index\": \"Î™©Ï∞®\","
              for folder in $subdirs; do
                label=$(get_label "$folder")
                echo "  \"$folder\": \"$label\","
              done
              for file in $files; do
                label=$(get_label "$file")
                echo "  \"$file\": \"$label\","
              done
            } | sed '$!s/,$//' > "$META_FILE"
            echo "}" >> "$META_FILE"
          done

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò: $FILE_COUNTÍ∞ú

          Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:
          $FILE_LIST
          EOF
          )
          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
