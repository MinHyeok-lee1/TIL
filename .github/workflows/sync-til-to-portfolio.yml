name: üîÑ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL files including tags
        run: |
          mkdir -p portfolio-repo/src/pages/til/
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'README.md' \
            til-repo/ portfolio-repo/src/pages/til/

      - name: Convert .md to .mdx (excluding tags/)
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" ! -path "*/tags/*" | while read file; do
            mv "$file" "${file%.md}.mdx"
          done

      - name: Generate _meta.json and index.mdx files
        run: |
          echo "üìÅ Generating _meta.json and index.mdx files..."

          title_case() {
            echo "$1" | sed -E 's/(^|-)([a-z])|\b([0-9]{2})\b/\U\2\U\3/g'
          }

          create_meta_and_index() {
            DIR=$1
            TITLE=$2
            INDEX_FILE="$DIR/index.mdx"
            META_FILE="$DIR/_meta.json"

            mkdir -p "$DIR"

            folders=$(find "$DIR" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort || true)
            files=$(find "$DIR" -mindepth 1 -maxdepth 1 -type f -name '*.mdx' ! -name 'index.mdx' | sort || true)

            if [ -n "$folders$files" ]; then
              echo "{" > "$META_FILE"
              echo "  \"index\": \"$TITLE\"," >> "$META_FILE"

              for path in $folders $files; do
                name=$(basename "$path")
                key="${name%.mdx}"
                label="$key"

                if [[ "$key" =~ ^[0-9]{2}- ]]; then
                  day="${key%%-*}"
                  tag="${key#*-}"
                  label="${day}Ïùº $(title_case "$tag")"
                elif [[ "$key" =~ ^til-[0-9]{2}$ ]]; then
                  label="${key#til-}Ïõî TIL"
                elif [[ "$key" =~ ^til-[0-9]{4}$ ]]; then
                  label="${key#til-}ÎÖÑ TIL"
                fi

                echo "  \"$key\": \"$label\"," >> "$META_FILE"
              done
              sed -i '$ s/,$//' "$META_FILE" || sed -i '' '$ s/,$//' "$META_FILE"
              echo "}" >> "$META_FILE"
            fi

            # index.mdx ÏÉùÏÑ± (ÌïÑÏöîÏãúÎßå)
            if [ ! -f "$INDEX_FILE" ]; then
              echo "# $TITLE" > "$INDEX_FILE"
              echo "" >> "$INDEX_FILE"
              echo "$TITLE ÌéòÏù¥ÏßÄÏûÖÎãàÎã§." >> "$INDEX_FILE"
            fi
          }

          # til Î£®Ìä∏ ÏÜåÍ∞ú ÌéòÏù¥ÏßÄÎäî Í≥†Ï†ï ÏÉùÏÑ±
          TIL_INDEX="portfolio-repo/src/pages/til/index.mdx"
          cat <<EOF > "$TIL_INDEX"
          # Today I Learned (TIL)

          > ÍΩ§Ï§ÄÌïú Í∏∞Î°ùÏùÄ ÏµúÍ≥†Ïùò ÏÑ±Ïû•ÏúºÎ°ú Ïù¥Ïñ¥ÏßÑÎã§.  
          Í∞úÎ∞ú/ÏûÑÎ≤†ÎîîÎìú/ÎèÑÍµ¨Ïóê ÎåÄÌïú ÌïôÏäµ Í∏∞Î°ùÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.

          ## üìÖ Ïó∞ÎèÑÎ≥Ñ

          - [üèÉ‚ÄçÔ∏èÌÉúÍ∑∏ Î™©Î°ù](/til/tags)
          - [2025ÎÖÑ TIL](/til/til-2025)
          EOF

          # til Î£®Ìä∏ _meta.json
          echo '{"index": "ÏÜåÍ∞ú", "til-2025": "2025ÎÖÑ TIL", "tags": "ÌÉúÍ∑∏ Î™©Î°ù"}' > portfolio-repo/src/pages/til/_meta.json

          # Ïó∞ÎèÑ/Ïõî Î≥Ñ ÏÉùÏÑ±
          for year_dir in portfolio-repo/src/pages/til/[0-9][0-9][0-9][0-9]; do
            [ -d "$year_dir" ] || continue
            year=$(basename "$year_dir")
            year_path="portfolio-repo/src/pages/til/til-$year"
            mv "$year_dir" "$year_path"
            create_meta_and_index "$year_path" "üìÖ $yearÎÖÑ TIL"

            for month_dir in "$year_path"/*; do
              [ -d "$month_dir" ] || continue
              month=$(basename "$month_dir")
              new_month_path="$year_path/til-$month"
              mv "$month_dir" "$new_month_path"
              create_meta_and_index "$new_month_path" "üóìÔ∏è $yearÎÖÑ ${month}Ïõî TIL"
            done
          done

          # tags index + meta
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          TAGS_META="$TAGS_DIR/_meta.json"
          TAGS_INDEX="$TAGS_DIR/index.mdx"

          if [ -d "$TAGS_DIR" ]; then
            echo "{\n  \"index\": \"\ud0dc\uadf8 \ubaa9\ub85d\"" > "$TAGS_META"
            echo "# üçøÔ∏è ÌÉúÍ∑∏ Î™©Î°ù" > "$TAGS_INDEX"
            echo "" >> "$TAGS_INDEX"
            echo "| ÌÉúÍ∑∏ | Nextra Ï†ïÎ¶¨ | GitHub Î∞îÎ°úÍ∞ÄÍ∏∞ |" >> "$TAGS_INDEX"
            echo "|------|---------------|------------------|" >> "$TAGS_INDEX"

            for tag_file in "$TAGS_DIR"/*.md; do
              [ -f "$tag_file" ] || continue
              tag=$(basename "$tag_file" .md)

              echo "  ,\"$tag\": \"$tag\"" >> "$TAGS_META"
              echo "| $tag | [Nextra Ï†ïÎ¶¨](/til/tags/$tag.md) | [GitHub Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$tag.md) |" >> "$TAGS_INDEX"
            done
            echo "}" >> "$TAGS_META"
          fi

      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"

          git add .
          CHANGED_FILES=$(git diff --cached --name-only)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes"
            exit 0
          fi

          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          FILE_LIST=$(echo "$CHANGED_FILES" | sed 's/^/ - /')

          COMMIT_MSG="üìù Sync TIL to portfolio: $(date +'%Y-%m-%d') (commit: ${GITHUB_SHA::7})"
          COMMIT_BODY=$(cat <<EOF
          Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò: $FILE_COUNTÍ∞ú

          Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:
          $FILE_LIST
          EOF
          )

          git commit -m "$COMMIT_MSG" -m "$COMMIT_BODY"
          git push || { echo "‚ö†Ô∏è Git push failed"; exit 1; }
