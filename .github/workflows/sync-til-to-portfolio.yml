name: ðŸ”„ Sync TIL to Portfolio

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-to-portfolio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout TIL repository (this repo)
        uses: actions/checkout@v3
        with:
          path: til-repo

      - name: Checkout Portfolio repository
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      - name: Copy TIL content into Portfolio
        run: |
          mkdir -p portfolio-repo/src/pages/til
          for YEAR in $(find til-repo -mindepth 1 -maxdepth 1 -type d -regex 'til-repo/[0-9]{4}' -exec basename {} \;); do
            for MONTH in $(find "til-repo/$YEAR" -mindepth 1 -maxdepth 1 -type d -regex "til-repo/$YEAR/[0-9]{2}" -exec basename {} \;); do
              mkdir -p "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH"
              cp til-repo/$YEAR/$MONTH/*.md "portfolio-repo/src/pages/til/til-$YEAR/til-$MONTH/" || true
            done
          done
          cp -r til-repo/tags portfolio-repo/src/pages/til/

      - name: Convert all .md to .mdx
        run: |
          find portfolio-repo/src/pages/til -type f -name "*.md" -exec bash -c 'mv "$0" "${0%.md}.mdx"' {} \;

      - name: Create index.mdx and _meta.json
        run: |
          BASE="portfolio-repo/src/pages/til"
          mkdir -p "$BASE"
          echo '{' > "$BASE/_meta.json"
          echo '  "index": "ì†Œê°œ",' >> "$BASE/_meta.json"
          echo '  "tags": "íƒœê·¸ ëª¨ìŒ"' >> "$BASE/_meta.json"

          cat <<EOF > "$BASE/index.mdx"
          # ðŸ““ Today I Learned (TIL)

          > ê¾¸ì¤€í•œ ê¸°ë¡ì€ ìµœê³ ì˜ ì„±ìž¥ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.

          ## ðŸ“… ì—°ë„ë³„

          EOF

          echo "- [ðŸ·ï¸ íƒœê·¸ ëª¨ìŒ](/til/tags)" >> "$BASE/index.mdx"
          for YEAR_PATH in "$BASE"/til-[0-9][0-9][0-9][0-9]; do
            YEAR=$(basename "$YEAR_PATH" | cut -d'-' -f2)
            echo "- [$YEARë…„ TIL](/til/til-$YEAR)" >> "$BASE/index.mdx"
            echo '  ,"til-'$YEAR'": "'$YEAR'ë…„ TIL"' >> "$BASE/_meta.json"

            echo "# ì†Œê°œ" > "$YEAR_PATH/index.mdx"
            echo "" >> "$YEAR_PATH/index.mdx"
            echo "$YEARë…„ TIL ê¸°ë¡ìž…ë‹ˆë‹¤." >> "$YEAR_PATH/index.mdx"
            echo "" >> "$YEAR_PATH/index.mdx"
            echo "| ì›” | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$YEAR_PATH/index.mdx"
            echo "|----|------------------|------------------|" >> "$YEAR_PATH/index.mdx"

            echo '{' > "$YEAR_PATH/_meta.json"
            echo '  "index": "ì†Œê°œ"' >> "$YEAR_PATH/_meta.json"

            for MONTH_PATH in "$YEAR_PATH"/til-*; do
              MONTH=$(basename "$MONTH_PATH" | cut -d'-' -f2)
              echo "| ${MONTH}ì›” | [Nextra ë°”ë¡œê°€ê¸°](/til/til-$YEAR/til-$MONTH) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/tree/main/$YEAR/$MONTH) |" >> "$YEAR_PATH/index.mdx"
              echo '  ,"til-'$MONTH'": "'$MONTH'ì›” TIL"' >> "$YEAR_PATH/_meta.json"

              echo "# ì†Œê°œ" > "$MONTH_PATH/index.mdx"
              echo "" >> "$MONTH_PATH/index.mdx"
              echo "${MONTH}ì›”ì˜ TIL ê¸°ë¡ìž…ë‹ˆë‹¤." >> "$MONTH_PATH/index.mdx"
              echo "" >> "$MONTH_PATH/index.mdx"
              echo "| ì œëª© | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$MONTH_PATH/index.mdx"
              echo "|-------|------------------|------------------|" >> "$MONTH_PATH/index.mdx"

              echo '{' > "$MONTH_PATH/_meta.json"
              echo '  "index": "ì†Œê°œ"' >> "$MONTH_PATH/_meta.json"

              for FILE in "$MONTH_PATH"/*.mdx; do
                FNAME=$(basename "$FILE" .mdx)
                [ "$FNAME" = "index" ] && continue
                DAY=$(echo "$FNAME" | cut -d'-' -f1)
                TITLE=$(echo "${FNAME:3}" | sed 's/-/ /g')
                echo "| ${DAY}ì¼ $TITLE | [Nextra ë°”ë¡œê°€ê¸°](/til/til-$YEAR/til-$MONTH/$FNAME) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH/$FNAME.md) |" >> "$MONTH_PATH/index.mdx"
                echo '  ,"'$FNAME'": "'${DAY}ì¼ $TITLE'"' >> "$MONTH_PATH/_meta.json"
              done

              echo "}" >> "$MONTH_PATH/_meta.json"
            done

            echo "}" >> "$YEAR_PATH/_meta.json"
          done

          echo "}" >> "$BASE/_meta.json"

      - name: Convert tags and generate tag index
        run: |
          TAGS_DIR="portfolio-repo/src/pages/til/tags"
          echo '# ì†Œê°œ

          TIL íƒœê·¸ ëª¨ìŒìž…ë‹ˆë‹¤.

          | íƒœê·¸ | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |
          |------|------------------|------------------|' > "$TAGS_DIR/index.mdx"
          echo '{ "index": "ì†Œê°œ" }' > "$TAGS_DIR/_meta.json"

          for TAG_FILE in "$TAGS_DIR"/*.mdx; do
            TAG=$(basename "$TAG_FILE" .mdx)
            [ "$TAG" = "index" ] && continue
            echo "# ðŸ·ï¸ $TAG TIL ëª¨ìŒ" > "$TAG_FILE"
            echo "" >> "$TAG_FILE"
            echo "| ì œëª© | Nextra ë°”ë¡œê°€ê¸° | GitHub ë°”ë¡œê°€ê¸° |" >> "$TAG_FILE"
            echo "|-------|------------------|------------------|" >> "$TAG_FILE"

            for FILE in portfolio-repo/src/pages/til/til-*/til-*/*.mdx; do
              FNAME=$(basename "$FILE" .mdx)
              [ "$FNAME" = "index" ] && continue
              if grep -q "tags:.*\b$TAG\b" "$FILE"; then
                YM=$(echo "$FILE" | grep -o 'til-[0-9]*/til-[0-9]*')
                TITLE=$(echo "${FNAME:3}" | sed 's/-/ /g')
                echo "| $TITLE | [Nextra ë°”ë¡œê°€ê¸°](/til/$YM/$FNAME) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/${YM/til-/}/$FNAME.md) |" >> "$TAG_FILE"
              fi
            done

            echo "| $TAG | [Nextra ë°”ë¡œê°€ê¸°](/til/tags/$TAG) | [GitHub ë°”ë¡œê°€ê¸°](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$TAG.md) |" >> "$TAGS_DIR/index.mdx"
          done

      # - name: Deploy to Vercel
      #   if: always()
      #   run: |
      #     set -e
      #     npm install -g vercel
      #     FORCE_FLAG=""
      #     if [ "${{ steps.pushcheck.outputs.should_force }}" == "true" ]; then
      #       FORCE_FLAG="--force"
      #     fi
      #     vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes $FORCE_FLAG --debug
      #   working-directory: portfolio-repo
