name: ğŸ”„ Sync TIL to Portfolio

on:
  push:
    branches: [main] # main ë¸Œëœì¹˜ì— md íŒŒì¼ í‘¸ì‹œ ì‹œ ë™ì‘
    paths: ["**/*.md"] # .md íŒŒì¼ ë³€ê²½ì—ë§Œ ë°˜ì‘
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©

jobs:
  sync-til:
    runs-on: ubuntu-latest
    steps:
      # 1. TIL repo í´ë¡  (ìì‹ ì˜ md ê¸°ë¡ì´ ìˆëŠ” ì›ë³¸ ì €ì¥ì†Œ)
      - name: Checkout TIL repo
        uses: actions/checkout@v3
        with:
          path: til-repo

      # 2. í¬íŠ¸í´ë¦¬ì˜¤ repo í´ë¡  (nextra ê¸°ë°˜ mdx íŒŒì¼ì´ ì €ì¥ë  ëª©ì ì§€ ì €ì¥ì†Œ)
      - name: Checkout Portfolio repo
        uses: actions/checkout@v3
        with:
          repository: MinHyeok-lee1/MinHyeok-lee1-portfolio
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: portfolio-repo

      # 3. portfolio repoì—ì„œ ê¸°ì¡´ TIL pages í´ë” ì „ì²´ ì‚­ì œ (ì´ì „ ë°ì´í„° ì œê±°)
      - name: Cleanup old TIL pages
        run: |
          rm -rf portfolio-repo/pages/til

      # 4. md íŒŒì¼ì„ mdxë¡œ ë³€í™˜/ë³µì‚¬ ë° í´ë” êµ¬ì¡° ë§ì¶”ê¸°
      #    (ex. til-repo/2025/07/05-git-test.md -> portfolio-repo/pages/til/til-2025/til-07/05-git-test.mdx)
      - name: Sync and convert TIL files
        run: |
          set -e
          SRC_BASE="til-repo"
          DEST_BASE="portfolio-repo/pages/til"

          mkdir -p "$DEST_BASE"

          # ë…„/ì›”ë³„ md íŒŒì¼ì„ mdxë¡œ ë³€í™˜í•´ì„œ ëª©ì ì§€ë¡œ ë³µì‚¬
          find "$SRC_BASE" -type f -name "*.md" ! -path "$SRC_BASE/tags/*" | grep -vE '^til-repo/README\.md$' | while read FILE; do
            REL_PATH="${FILE#$SRC_BASE/}"
            YEAR=$(echo "$REL_PATH" | cut -d'/' -f1)
            MONTH=$(echo "$REL_PATH" | cut -d'/' -f2)
            FNAME=$(basename "$REL_PATH" .md)

            [[ "$YEAR" =~ ^[0-9]{4}$ ]] || continue
            [[ "$MONTH" =~ ^[0-9]{2}$ ]] || continue

            mkdir -p "$DEST_BASE/til-$YEAR"
            DEST_DIR="$DEST_BASE/til-$YEAR/til-$MONTH"
            mkdir -p "$DEST_DIR"
            cp "$FILE" "$DEST_DIR/$FNAME.mdx"
          done

          # tags ë””ë ‰í† ë¦¬ ë‚´ md íŒŒì¼ë„ mdxë¡œ ë³€í™˜í•´ì„œ ë³µì‚¬ (íƒœê·¸ë³„ ë¬¸ì„œìš©)
          TAGS_SRC="$SRC_BASE/tags"
          TAGS_DEST="$DEST_BASE/tags"
          mkdir -p "$TAGS_DEST"
          shopt -s nullglob
          for FILE in "$TAGS_SRC"/*.md; do
            TAG_NAME=$(basename "$FILE" .md)
            MDX_FILE="$TAGS_DEST/$TAG_NAME.mdx"

            echo "# ğŸ·ï¸ $TAG_NAME TIL ëª¨ìŒ" > "$MDX_FILE"
            echo "" >> "$MDX_FILE"
            echo '> <img src="/vercel.png" width="18" style="vertical-align:middle" /> : Nextra(í¬íŠ¸í´ë¦¬ì˜¤)   <img src="/github.png" width="18" style="vertical-align:middle" /> : GitHub(ì›ë³¸)' >> "$MDX_FILE"
            echo "" >> "$MDX_FILE"
            echo "| ì œëª© | ë°”ë¡œê°€ê¸° | Summary |" >> "$MDX_FILE"
            echo "|------|----------|---------|" >> "$MDX_FILE"

            # ë³¸ë¬¸ í–‰ íŒŒì‹±í•´ì„œ ë³€í™˜
            tail -n +3 "$FILE" | while IFS='|' read -r _ TITLE DATE SUMMARY _; do
              # í—¤ë”/êµ¬ë¶„ì„  íŒ¨ìŠ¤
              [[ "$TITLE" == "Title" || "$TITLE" == "---" || -z "$TITLE" ]] && continue

              # Titleì´ [í…ìŠ¤íŠ¸](ë§í¬)ë©´ ë‚´ë¶€ì—ì„œ slug ì¶”ì¶œ
              # TITLEì—ì„œ "](ë§í¬)" ì „ê¹Œì§€ slug ì¶”ì¶œ
              LINK_TEXT=$(echo "$TITLE" | grep -oP '\[[^]]+\]' | tr -d '[]')
              GITHUB_LINK=$(echo "$TITLE" | grep -oP '\(([^)]+)\)' | tr -d '()')

              # íŒŒì¼ëª… slug: ê¹ƒí—ˆë¸Œ ë§í¬ì—ì„œ ë§ˆì§€ë§‰ segment ì¶”ì¶œ, .md ë–¼ê³  ì‚¬ìš©
              SLUG=$(basename "$GITHUB_LINK" .md)

              # ë‚ ì§œ ë¶„í•´
              Y=$(echo "$DATE" | cut -d'-' -f1)
              M=$(echo "$DATE" | cut -d'-' -f2)

              # Nextra ê²½ë¡œ ì¡°ë¦½
              NEXTRA_LINK="/til/til-$Y/til-$M/$SLUG"

              # Summary ì •ë¦¬ (ì•ë’¤ê³µë°± ì œê±°)
              SUMMARY=$(echo "$SUMMARY" | xargs)

              # í–‰ ìƒì„±
              echo "| [Nextra ë°”ë¡œê°€ê¸°]($NEXTRA_LINK) | [GitHub ë°”ë¡œê°€ê¸°]($GITHUB_LINK) | $SUMMARY |" >> "$MDX_FILE"
            done
          done
          shopt -u nullglob

      # 5. íƒœê·¸ í˜ì´ì§€ìš© ë©”íƒ€íŒŒì¼(_meta.json) ë° index.mdx ìƒì„±
      - name: Create tags/_meta.json and index.mdx
        run: |
          TAGS_DIR="portfolio-repo/pages/til/tags"
          mkdir -p "$TAGS_DIR"

          # íƒœê·¸ë³„ mdx íŒŒì¼ ì´ë¦„ì„ ëª¨ì•„ íƒœê·¸ ë„¤ë¹„ê²Œì´ì…˜ìš© _meta.json ìƒì„±
          TAG_META_ITEMS=()
          for FILE in "$TAGS_DIR"/*.mdx; do
            [ -f "$FILE" ] || continue
            NAME=$(basename "$FILE" .mdx)
            [ "$NAME" = "index" ] && continue
            TAG_META_ITEMS+=("\"$NAME\": \"$NAME íƒœê·¸\"")
          done
          {
            echo "{"
            echo '  "index": "ë¬¸ì„œê°œìš”"'
            for ITEM in "${TAG_META_ITEMS[@]}"; do
              echo "  ,$ITEM"
            done
            echo "}"
          } > "$TAGS_DIR/_meta.json"

          # íƒœê·¸ ëª¨ìŒ index.mdx ìƒì„± (íƒœê·¸ë³„ë¡œ nextra/github ë§í¬ í‘œ)
          echo "# ğŸ·ï¸ íƒœê·¸ ëª¨ìŒ" > "$TAGS_DIR/index.mdx"
          echo '> <img src="/vercel.png" width="18" style="vertical-align:middle" /> : Nextra(í¬íŠ¸í´ë¦¬ì˜¤)   <img src="/github.png" width="18" style="vertical-align:middle" /> : GitHub(ì›ë³¸)' >> "$TAGS_DIR/index.mdx"
          echo "" >> "$TAGS_DIR/index.mdx"
          echo "| íƒœê·¸ | ë°”ë¡œê°€ê¸° |" >> "$TAGS_DIR/index.mdx"
          echo "|------|----------|" >> "$TAGS_DIR/index.mdx"
          for FILE in "$TAGS_DIR"/*.mdx; do
            NAME=$(basename "$FILE" .mdx)
            [ "$NAME" = "index" ] && continue
            echo "| $NAME | [Nextra](/til/tags/$NAME) \| [GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/tags/$NAME.md) |" >> "$TAGS_DIR/index.mdx"
          done

      # 6. TIL ì—°/ì›”ë³„ _meta.json ë° index.mdx íŒŒì¼ ì¼ê´„ ìƒì„± (ë„¤ë¹„/ëª©ì°¨, nextra, github ë§í¬)
      - name: Create all _meta.json and index.mdx files
        run: |
          BASE="portfolio-repo/pages/til"
          YEARS=()
          for YEAR_DIR in "$BASE"/til-*; do
            [ -d "$YEAR_DIR" ] || continue
            YEARS+=("$(basename "$YEAR_DIR" | cut -d'-' -f2)")
          done
          {
            echo "{"
            echo '  "index": "ë¬¸ì„œê°œìš”"'
            echo '  ,"tags": "íƒœê·¸ëª¨ìŒ"'
            for YEAR in "${YEARS[@]}"; do
              echo '  ,"til-'"$YEAR"'": "'"$YEAR"'ë…„ TIL"'
            done
            echo "}"
          } > "$BASE/_meta.json"

          # TIL ì „ì²´ ëª©ì°¨(index.mdx)
          echo "# ğŸ““ Today I Learned (TIL)" > "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "> ê¾¸ì¤€í•œ ê¸°ë¡ì€ ìµœê³ ì˜ ì„±ì¥ìœ¼ë¡œ ì´ì–´ì§„ë‹¤." >> "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "[ğŸ·ï¸ íƒœê·¸ëª¨ìŒ](/til/tags)" >> "$BASE/index.mdx"
          echo "" >> "$BASE/index.mdx"
          echo "## ğŸ“… ì—°ë„ë³„" >> "$BASE/index.mdx"
          for YEAR in "${YEARS[@]}"; do
            echo "- [${YEAR}ë…„ TIL](/til/til-$YEAR)" >> "$BASE/index.mdx"
          done

          # ì—°ë„ë³„/ì›”ë³„ _meta.json, index.mdx ìƒì„± (ì›”ë³„, ì¼ë³„ë¡œ ìë™í™”)
          for YEAR in "${YEARS[@]}"; do
            YEAR_DIR="$BASE/til-$YEAR"
            MONTHS=()
            for MONTH_DIR in "$YEAR_DIR"/til-*; do
              [ -d "$MONTH_DIR" ] || continue
              MONTHS+=("til-$(basename "$MONTH_DIR" | cut -d'-' -f2)")
            done
            {
              echo "{"
              echo '  "index": "ë¬¸ì„œê°œìš”"'
              for MONTH in "${MONTHS[@]}"; do
                M=$(echo "$MONTH" | cut -d'-' -f2)
                echo '  ,"'"$MONTH"'": "'"$M"'ì›” TIL"'
              done
              echo "}"
            } > "$YEAR_DIR/_meta.json"

            # ì—°ë„ë³„ index.mdx (ì›”ë³„ í‘œ)
            echo "# ë¬¸ì„œê°œìš”" > "$YEAR_DIR/index.mdx"
            echo "${YEAR}ë…„ TIL ê¸°ë¡ì…ë‹ˆë‹¤." >> "$YEAR_DIR/index.mdx"
            echo '> <img src="/vercel.png" width="18" style="vertical-align:middle" /> : Nextra(í¬íŠ¸í´ë¦¬ì˜¤)   <img src="/github.png" width="18" style="vertical-align:middle" /> : GitHub(ì›ë³¸)' >> "$YEAR_DIR/index.mdx"
            echo "" >> "$YEAR_DIR/index.mdx"
            echo "| ì›” | ë°”ë¡œê°€ê¸° |" >> "$YEAR_DIR/index.mdx"
            echo "|----|----------|" >> "$YEAR_DIR/index.mdx"
            for MONTH_DIR in "$YEAR_DIR"/til-*; do
              [ -d "$MONTH_DIR" ] || continue
              MONTH=$(basename "$MONTH_DIR" | cut -d'-' -f2)
              echo "| ${MONTH}ì›” | [Nextra](/til/til-$YEAR/til-$MONTH) \| [GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH) |" >> "$YEAR_DIR/index.mdx"
            done

            # ì›”ë³„ index.mdx (ì¼/ì œëª© í‘œ) ë° ì›”ë³„ _meta.json
            for MONTH_DIR in "$YEAR_DIR"/til-*; do
              [ -d "$MONTH_DIR" ] || continue
              MONTH_META_ITEMS=()
              FILES=()
              for FILE in "$MONTH_DIR"/*.mdx; do
                [ -f "$FILE" ] || continue
                FNAME=$(basename "$FILE" .mdx)
                [ "$FNAME" = "index" ] && continue
                DAY=$(echo "$FNAME" | cut -d'-' -f1)
                TITLE_CLEAN=$(echo "$FNAME" | cut -d'-' -f2- | sed 's/-/ /g')
                MONTH_META_ITEMS+=("\"$FNAME\": \"${DAY}ì¼ ${TITLE_CLEAN}\"")
                FILES+=("$FNAME")
              done
              {
                echo "{"
                echo '  "index": "ë¬¸ì„œê°œìš”"'
                for ITEM in "${MONTH_META_ITEMS[@]}"; do
                  echo "  ,$ITEM"
                done
                echo "}"
              } > "$MONTH_DIR/_meta.json"

              MONTH_NUM=$(basename "$MONTH_DIR" | cut -d'-' -f2)
              echo "# ë¬¸ì„œê°œìš”" > "$MONTH_DIR/index.mdx"
              echo "${YEAR}ë…„ ${MONTH_NUM}ì›” TIL ê¸°ë¡ì…ë‹ˆë‹¤." >> "$MONTH_DIR/index.mdx"
              echo '> <img src="/vercel.png" width="18" style="vertical-align:middle" /> : Nextra(í¬íŠ¸í´ë¦¬ì˜¤)   <img src="/github.png" width="18" style="vertical-align:middle" /> : GitHub(ì›ë³¸)' >> "$MONTH_DIR/index.mdx"
              echo "" >> "$MONTH_DIR/index.mdx"
              echo "| ì œëª© | ë°”ë¡œê°€ê¸° |" >> "$MONTH_DIR/index.mdx"
              echo "|------|----------|" >> "$MONTH_DIR/index.mdx"
              for FNAME in "${FILES[@]}"; do
                DAY=$(echo "$FNAME" | cut -d'-' -f1)
                TITLE_CLEAN=$(echo "$FNAME" | cut -d'-' -f2- | sed 's/-/ /g')
                echo "| ${DAY}ì¼ ${TITLE_CLEAN} | [Nextra](/til/til-$YEAR/til-$MONTH_NUM/$FNAME) \| [GitHub](https://github.com/MinHyeok-lee1/TIL/blob/main/$YEAR/$MONTH_NUM/$FNAME.md) |" >> "$MONTH_DIR/index.mdx"
              done
            done
          done

      # 7. ë³€ê²½ì‚¬í•­ ìˆìœ¼ë©´ ì»¤ë°‹/í‘¸ì‹œ (ìë™ ì ìš©)
      - name: Commit and Push
        run: |
          cd portfolio-repo
          git config user.name "MinHyeok-lee1"
          git config user.email "minhyeok.lee1@gmail.com"
          git add .
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi
          git commit -m "ğŸ“ Sync TIL to portfolio: $(date +'%Y-%m-%d')"
          git push
